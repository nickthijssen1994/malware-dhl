package com.jingdong.aura.core.p122b.p124b;

import android.app.Application;
import android.os.Build;
import com.jingdong.aura.core.p121a.C2119a;
import com.jingdong.aura.core.p122b.C2150e;
import com.jingdong.aura.core.p122b.C2151f;
import com.jingdong.aura.core.p122b.C2152g;
import com.jingdong.aura.core.p122b.C2153h;
import com.jingdong.aura.core.p122b.C2154i;
import com.jingdong.aura.core.p122b.p125c.C2148h;
import com.jingdong.aura.core.util.C2194a;
import com.jingdong.aura.core.util.C2200c;
import com.jingdong.aura.core.util.C2201d;
import com.jingdong.aura.core.util.C2203f;
import com.jingdong.aura.core.util.C2204g;
import com.jingdong.aura.core.util.C2205h;
import com.jingdong.aura.core.util.p127a.AbstractC2197b;
import com.jingdong.aura.core.util.p127a.C2198c;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Properties;
import java.util.StringTokenizer;
import java.util.concurrent.ConcurrentHashMap;
import org.osgi.framework.BundleException;
import org.osgi.framework.a;
import org.osgi.framework.b;
import org.osgi.framework.c;
import org.osgi.framework.e;

/* compiled from: TbsSdkJava */
/* renamed from: com.jingdong.aura.core.b.b.b */
/* loaded from: classes.dex */
public final class C2131b {

    /* renamed from: d */
    public static boolean f3871d;

    /* renamed from: h */
    private static C2133d f3875h;

    /* renamed from: j */
    private static C2134e f3877j;

    /* renamed from: k */
    private static ClassLoader f3878k;

    /* renamed from: o */
    private static String f3882o;

    /* renamed from: g */
    private static final AbstractC2197b f3874g = C2198c.m255a(C2131b.class);

    /* renamed from: i */
    private static boolean f3876i = false;

    /* renamed from: l */
    private static List<e> f3879l = new ArrayList();

    /* renamed from: m */
    private static Map<String, List<e>> f3880m = new HashMap();

    /* renamed from: a */
    public static boolean f3868a = true;

    /* renamed from: b */
    public static boolean f3869b = true;

    /* renamed from: c */
    public static boolean f3870c = true;

    /* renamed from: n */
    private static String f3881n = null;

    /* renamed from: p */
    private static String f3883p = null;

    /* renamed from: q */
    private static List<String> f3884q = new ArrayList();

    /* renamed from: r */
    private static int f3885r = 1;

    /* renamed from: s */
    private static int f3886s = 0;

    /* renamed from: t */
    private static Map<C2154i, C2154i> f3887t = new ConcurrentHashMap();

    /* renamed from: u */
    private static int f3888u = 0;

    /* renamed from: e */
    static boolean f3872e = false;

    /* renamed from: f */
    static Map<String, String> f3873f = new HashMap();

    private C2131b() {
    }

    /* renamed from: a */
    public static void m593a(Application application, Properties properties) {
        f3875h = new C2133d(properties);
        m594a(application);
    }

    /* renamed from: a */
    private static void m594a(Application application) {
        boolean z;
        int i;
        f3876i = true;
        f3874g.mo264a("---------------------------------------------------------");
        AbstractC2197b bVar = f3874g;
        bVar.mo264a("  Aura 1.2.36.15 on " + Build.MODEL + "/" + Build.CPU_ABI + "/" + Build.VERSION.RELEASE + " SDK version " + Build.VERSION.SDK_INT + " starting ...");
        f3874g.mo264a("---------------------------------------------------------");
        long currentTimeMillis = System.currentTimeMillis();
        m568m();
        m567n();
        boolean a = f3875h.m556a("osgi.init", false);
        if (a) {
            i = -1;
            z = false;
        } else {
            i = m566o();
            z = true;
        }
        if (i == -1) {
            File file = new File(f3882o);
            boolean a2 = C2204g.m234a(application);
            if (a && file.exists() && a2) {
                f3874g.mo261b("Purging storage ...");
                try {
                    C2203f.m237a(file);
                } catch (Throwable th) {
                    throw new RuntimeException("deleteDirectory failed", th);
                }
            }
            if (a && a2) {
                f3874g.mo261b("deleting storage Directory ...");
                C2203f.m238a();
            }
            try {
                file.mkdirs();
                Integer.getInteger("osgi.maxLevel", (Integer) 1).intValue();
                f3885r = f3875h.m558a("osgi.startlevel.bundle", 1);
                i = f3875h.m558a("osgi.startlevel.framework", 1);
                z = false;
            } catch (Throwable th2) {
                throw new RuntimeException("mkdirs failed", th2);
            }
        }
        C2132c.m563a(0, f3877j, null);
        f3877j.m553a((a[]) C2130a.m603a().toArray(new a[C2130a.m600b()]), i, false);
        f3876i = false;
        if (!z) {
            try {
                m565p();
            } catch (Throwable th3) {
                throw new RuntimeException("storeProfile failed", th3);
            }
        }
        long currentTimeMillis2 = System.currentTimeMillis() - currentTimeMillis;
        f3874g.mo264a("---------------------------------------------------------");
        AbstractC2197b bVar2 = f3874g;
        StringBuilder sb = new StringBuilder();
        sb.append("  Framework ");
        sb.append(z ? "restarted" : "started");
        sb.append(" in ");
        sb.append(currentTimeMillis2);
        sb.append(" milliseconds.");
        bVar2.mo264a(sb.toString());
        f3874g.mo264a("---------------------------------------------------------");
        f3877j.m554a(32);
        try {
            C2132c.m563a(1, f3877j, null);
        } catch (Throwable th4) {
            throw new RuntimeException("notifyFrameworkListeners failed", th4);
        }
    }

    /* renamed from: m */
    private static void m568m() {
        File a = C2201d.m249a();
        if (a == null || !a.exists()) {
            a = C2201d.m249a();
        }
        f3881n = f3875h.m557a("com.aura.basedir", a.getAbsolutePath());
        C2133d dVar = f3875h;
        f3883p = dVar.m557a("com.aura.jars", "file:" + f3881n);
        f3888u = f3875h.m558a("com.aura.classloader.buffersize", 10240);
        f3869b = f3875h.m556a("com.aura.debug.packages", false);
        f3870c = f3875h.m556a("com.aura.debug.services", false);
        f3868a = f3875h.m556a("com.aura.debug.classloading", false);
        if (f3875h.m556a("com.aura.debug", false)) {
            f3874g.mo261b("SETTING ALL DEBUG FLAGS");
            f3869b = true;
            f3870c = true;
            f3868a = true;
        }
        f3871d = f3875h.m556a("com.aura.strictStartup", false);
        String a2 = f3875h.m559a("org.osgi.framework.system.packages");
        if (a2 != null) {
            StringTokenizer stringTokenizer = new StringTokenizer(a2, ",");
            int countTokens = stringTokenizer.countTokens();
            for (int i = 0; i < countTokens; i++) {
                C2151f.m426a(stringTokenizer.nextToken().trim());
            }
        }
        C2133d dVar2 = f3875h;
        dVar2.m555b("org.osgi.framework.executionenvironment", System.getProperty("java.specification.name") + "/" + System.getProperty("java.specification.version"));
        String property = System.getProperty("os.name");
        if (property == null) {
            property = "undefined";
        }
        f3875h.m555b("org.osgi.framework.os.name", property);
        String property2 = System.getProperty("os.version");
        if (property2 == null) {
            property2 = "undefined";
        }
        f3875h.m555b("org.osgi.framework.os.version", property2);
        String property3 = System.getProperty("os.arch");
        if (property3 == null) {
            property3 = "undefined";
        }
        f3875h.m555b("org.osgi.framework.processor", property3);
        f3875h.m555b("org.osgi.framework.version", "1.2.36.15");
        f3875h.m555b("org.osgi.framework.vendor", "Aura");
        String language = Locale.getDefault().getLanguage();
        if (language == null) {
            language = "en";
        }
        f3875h.m555b("org.osgi.framework.language", language);
    }

    /* renamed from: n */
    private static void m567n() {
        StringBuilder sb = new StringBuilder();
        C2133d dVar = f3875h;
        sb.append(dVar.m557a("com.aura.storage", dVar.m557a("org.osgi.framework.dir", f3881n + File.separatorChar + "aura")));
        sb.append(File.separatorChar);
        f3882o = sb.toString();
        f3877j = new C2134e();
        f3877j.m554a(8);
    }

    /* renamed from: o */
    private static int m566o() {
        try {
            f3874g.mo261b("Restoring profile");
            File file = new File(f3882o, "meta");
            if (!file.exists()) {
                f3874g.mo261b("Profile not found, performing clean start ...");
                return -1;
            }
            DataInputStream dataInputStream = new DataInputStream(new FileInputStream(file));
            int readInt = dataInputStream.readInt();
            String[] e = C2205h.m220e(dataInputStream.readUTF(), ",");
            if (e != null) {
                f3884q.addAll(Arrays.asList(e));
            }
            dataInputStream.close();
            return readInt;
        } catch (Exception e2) {
            e2.printStackTrace();
            return 0;
        }
    }

    /* JADX WARN: Code restructure failed: missing block: B:28:0x0076, code lost:
        r1 = com.jingdong.aura.core.p121a.C2119a.m656a().m638i(r13);
     */
    /* JADX WARN: Code restructure failed: missing block: B:29:0x0082, code lost:
        if (android.text.TextUtils.isEmpty(r1) != false) goto L_0x008c;
     */
    /* JADX WARN: Code restructure failed: missing block: B:31:0x0088, code lost:
        if (r1.equals(r18) != false) goto L_0x008c;
     */
    /* JADX WARN: Code restructure failed: missing block: B:32:0x008a, code lost:
        r10 = r1;
     */
    /* JADX WARN: Code restructure failed: missing block: B:33:0x008c, code lost:
        r10 = r18;
     */
    /* JADX WARN: Code restructure failed: missing block: B:34:0x008d, code lost:
        if (r14 == null) goto L_0x00a2;
     */
    /* JADX WARN: Code restructure failed: missing block: B:35:0x008f, code lost:
        r0 = new com.jingdong.aura.core.p122b.C2153h(r12, r13, r16, new com.jingdong.aura.core.p122b.C2152g(), null, r14, true, r10);
     */
    /* JADX WARN: Code restructure failed: missing block: B:36:0x00a2, code lost:
        r0 = new com.jingdong.aura.core.p122b.C2153h(r12, r13, r16, new com.jingdong.aura.core.p122b.C2152g(), r15, null, true, r10);
     */
    /* JADX WARN: Code restructure failed: missing block: B:37:0x00b4, code lost:
        m598a();
     */
    /* JADX WARN: Code restructure failed: missing block: B:39:0x00c1, code lost:
        return r0;
     */
    /* renamed from: a */
    /* Code decompiled incorrectly, please refer to instructions dump */
    public static C2153h m588a(String str, File file, InputStream inputStream, long j, String str2) {
        C2153h a;
        if (str == null) {
            f3874g.mo258c("location is null");
            return null;
        }
        boolean c = C2119a.m656a().m646c(str);
        if (!c && file == null && inputStream == null) {
            f3874g.mo258c("apkFile or archiveInputStream is null");
            throw new RuntimeException("apkFile or archiveInputStream is null");
        }
        C2153h a2 = m590a(str);
        if (a2 != null) {
            return a2;
        }
        File file2 = new File(f3882o, str);
        try {
            C2200c.m251a(str);
            C2194a.m272a().m271a(file2);
            C2153h a3 = m590a(str);
            if (a3 != null) {
                return a3;
            }
            if (file2.exists() && (a = m592a(file2, str, j, str2)) != null) {
                return a;
            }
            throw new RuntimeException("can not install provided bundle:" + str);
        } finally {
            C2194a.m272a().m268b(file2);
            C2200c.m250b(str);
        }
    }

    /* renamed from: a */
    public static boolean m587a(String str, InputStream inputStream, int i, String str2) {
        if (str == null || inputStream == null) {
            f3874g.mo264a("locations and files must not be null");
            return false;
        }
        String valueOf = String.valueOf(System.currentTimeMillis());
        new File(new File(f3882o, "wal"), valueOf).mkdirs();
        C2200c.m251a(str);
        try {
            C2153h a = m590a(str);
            if (a != null) {
                a.m416a(inputStream, i, str2);
            } else {
                File file = new File(f3882o, str);
                if (file.exists()) {
                    AbstractC2197b bVar = f3874g;
                    bVar.mo261b("checkUpdateBundle. " + str);
                    C2153h.m417a(file, str, i, inputStream, str2);
                } else {
                    AbstractC2197b bVar2 = f3874g;
                    bVar2.mo261b("new bundleImpl. " + str);
                    new C2153h(file, str, (long) i, new C2152g(), inputStream, null, false, str2);
                }
            }
            f3884q.add(valueOf);
            m598a();
            return true;
        } finally {
            C2200c.m250b(str);
        }
    }

    /* renamed from: a */
    private static C2153h m592a(File file, String str, long j, String str2) {
        if (file == null || str == null) {
            return null;
        }
        long b = C2148h.m437b(file);
        if (!C2148h.m441a(j, str2, b, C2148h.m439a(file, b))) {
            return m589a(str, file, b);
        }
        return null;
    }

    /* renamed from: p */
    private static void m565p() {
        for (C2153h hVar : (C2153h[]) m574g().toArray(new C2153h[m574g().size()])) {
            hVar.m400p();
        }
        m598a();
    }

    /* renamed from: a */
    static void m598a() {
        try {
            File file = new File(f3882o, "meta");
            if (!file.getParentFile().exists()) {
                file.getParentFile().mkdirs();
            }
            if (!file.exists()) {
                try {
                    file.createNewFile();
                } catch (IOException e) {
                    f3874g.mo263a(e.getMessage(), e);
                }
            }
            DataOutputStream dataOutputStream = new DataOutputStream(new FileOutputStream(file));
            dataOutputStream.writeInt(f3886s);
            String a = C2205h.m226a(f3884q.toArray(), ",");
            if (a == null) {
                a = "";
            }
            dataOutputStream.writeUTF(a);
            dataOutputStream.flush();
            dataOutputStream.close();
        } catch (IOException e2) {
            C2150e.m428a("com.jingdong.aura", "storeMetadata failed", "Framework.storeMetadata", e2);
            f3874g.mo260b("Could not save meta data.", e2);
        }
    }

    /* renamed from: a */
    private static C2153h m589a(String str, File file, long j) {
        try {
            return new C2153h(file, new C2152g(), j);
        } catch (Throwable th) {
            C2150e.m428a(str, "restore bundle failed " + str, "Framework.restoreFromExistedBundle", th);
            AbstractC2197b bVar = f3874g;
            bVar.mo260b("restore bundle failed: " + str, th);
            th.printStackTrace();
            return null;
        }
    }

    /* renamed from: a */
    public static void m591a(ClassLoader classLoader) {
        f3878k = classLoader;
    }

    /* renamed from: b */
    public static ClassLoader m583b() {
        return f3878k;
    }

    /* renamed from: c */
    public static a m580c() {
        return f3877j;
    }

    /* renamed from: d */
    public static List m578d() {
        return f3879l;
    }

    /* renamed from: e */
    public static Map<String, List<e>> m576e() {
        return f3880m;
    }

    /* renamed from: f */
    public static boolean m575f() {
        return f3876i;
    }

    /* renamed from: a */
    public static void m585a(b bVar) {
        C2132c.m562a(bVar);
    }

    /* renamed from: b */
    public static void m581b(b bVar) {
        C2132c.m560b(bVar);
    }

    /* renamed from: a */
    public static void m584a(c cVar) {
        C2132c.m561a(cVar);
    }

    /* renamed from: a */
    public static void m596a(int i, a aVar) {
        C2132c.m564a(i, aVar);
    }

    /* renamed from: a */
    public static void m595a(int i, a aVar, Throwable th) {
        C2132c.m563a(i, aVar, th);
    }

    /* renamed from: g */
    public static List<a> m574g() {
        return C2130a.m603a();
    }

    /* renamed from: h */
    public static String m573h() {
        List<a> g = m574g();
        if (g == null || g.isEmpty()) {
            return "";
        }
        StringBuilder sb = new StringBuilder("InstalledBundles[");
        Iterator<a> it = g.iterator();
        while (it.hasNext()) {
            C2153h hVar = (a) it.next();
            sb.append(hVar.n());
            sb.append(":");
            sb.append(hVar.m401o());
            sb.append(";");
        }
        sb.append("]");
        return sb.toString();
    }

    /* renamed from: a */
    public static a m590a(String str) {
        return C2130a.m602a(str);
    }

    /* renamed from: a */
    public static void m586a(String str, a aVar) {
        C2130a.m601a(str, aVar);
    }

    /* renamed from: b */
    public static void m582b(String str) {
        C2130a.m599b(str);
    }

    /* renamed from: c */
    public static void m579c(String str) {
        if (str != null) {
            File file = new File(f3882o, str);
            C2194a.m272a().m271a(file);
            if (file.exists()) {
                C2203f.m237a(file);
            }
            C2194a.m272a().m268b(file);
        }
    }

    /* renamed from: i */
    public static void m572i() {
        List<String> d = C2119a.m656a().m644d();
        if (d != null) {
            for (String str : d) {
                if (str != null) {
                    a a = m590a(str);
                    if (a != null) {
                        try {
                            a.m();
                        } catch (BundleException e) {
                            e.printStackTrace();
                        }
                    }
                    m579c(str);
                }
            }
            C2203f.m238a();
        }
    }

    /* renamed from: j */
    public static File m571j() {
        return new File(f3882o);
    }

    /* renamed from: d */
    public static String m577d(String str) {
        return f3875h.m559a(str);
    }

    /* renamed from: k */
    public static int m570k() {
        return f3885r;
    }

    /* renamed from: l */
    public static int m569l() {
        return f3886s;
    }

    /* renamed from: a */
    public static void m597a(int i) {
        f3886s = i;
    }
}
