package com.p051jd.mobile.image.p106b;

import android.content.res.Resources;
import android.graphics.Bitmap;
import android.graphics.drawable.Animatable;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.Build;
import android.text.TextUtils;
import android.view.View;
import android.widget.ImageView;
import androidx.annotation.NonNull;
import androidx.core.view.ViewCompat;
import com.facebook.animated.giflite.GifDecoder;
import com.facebook.common.executors.CallerThreadExecutor;
import com.facebook.common.executors.UiThreadImmediateExecutorService;
import com.facebook.drawee.C0243R;
import com.facebook.drawee.backends.pipeline.Fresco;
import com.facebook.drawee.controller.BaseControllerListener;
import com.facebook.drawee.drawable.ScalingUtils;
import com.facebook.drawee.generic.GenericDraweeHierarchy;
import com.facebook.drawee.generic.GenericDraweeHierarchyBuilder;
import com.facebook.drawee.interfaces.DraweeController;
import com.facebook.drawee.view.DraweeHolder;
import com.facebook.drawee.view.SimpleDraweeView;
import com.facebook.fresco.animation.drawable.AnimatedDrawable2;
import com.facebook.imagepipeline.common.ImageDecodeOptions;
import com.facebook.imagepipeline.common.ImageDecodeOptionsBuilder;
import com.facebook.imagepipeline.common.RotationOptions;
import com.facebook.imagepipeline.image.EncodedImage;
import com.facebook.imagepipeline.image.ImageInfo;
import com.facebook.imagepipeline.request.ImageRequest;
import com.facebook.imagepipeline.request.ImageRequestBuilder;
import com.jingdong.JdImageToolKit;
import com.jingdong.app.util.image.JDDisplayImageOptions;
import com.jingdong.app.util.image.placeholder.JDPlaceholderDrawable;
import com.jingdong.jdsdk.widget.ExceptionDrawable;
import com.p051jd.mobile.image.AbstractC1956a;
import com.p051jd.mobile.image.ImageRequestListener;
import com.p051jd.mobile.image.p105a.C1957a;
import com.p051jd.mobile.image.p105a.C1960b;
import com.p051jd.mobile.image.p105a.C1961c;
import com.p051jd.mobile.image.p106b.p108b.C1978a;
import com.p051jd.mobile.image.p106b.p108b.View$OnAttachStateChangeListenerC1979b;
import java.util.concurrent.Executor;
import javax.annotation.Nullable;

/* renamed from: com.jd.mobile.image.b.a */
/* loaded from: classes.dex */
public class C1970a {

    /* renamed from: com.jd.mobile.image.b.a$a */
    /* loaded from: classes.dex */
    static class C1972a implements ImageRequestListener<EncodedImage> {

        /* renamed from: a */
        final /* synthetic */ String f3413a;

        /* renamed from: b */
        final /* synthetic */ AbstractC1956a f3414b;

        C1972a(String str, AbstractC1956a aVar) {
            this.f3413a = str;
            this.f3414b = aVar;
        }

        /* renamed from: a */
        public void onSuccess(EncodedImage encodedImage) {
            if (encodedImage != null) {
                try {
                    if (encodedImage.getInputStream() != null) {
                        C1961c.m1053a(this.f3413a, C1961c.m1054a(encodedImage.getInputStream()));
                        if (this.f3414b != null) {
                            this.f3414b.m1061a(this.f3413a);
                        }
                    }
                } catch (Throwable th) {
                    AbstractC1956a aVar = this.f3414b;
                    if (aVar != null) {
                        aVar.onFailure(th);
                    }
                }
            }
        }

        @Override // com.p051jd.mobile.image.ImageRequestListener
        public void onCancel() {
            AbstractC1956a aVar = this.f3414b;
            if (aVar != null) {
                aVar.onCancel();
            }
        }

        @Override // com.p051jd.mobile.image.ImageRequestListener
        public void onFailure(Throwable th) {
            AbstractC1956a aVar = this.f3414b;
            if (aVar != null) {
                aVar.onFailure(th);
            }
        }
    }

    /* renamed from: a */
    public static GenericDraweeHierarchy m1043a(View view, JDDisplayImageOptions jDDisplayImageOptions) {
        Drawable drawable;
        Drawable drawable2;
        boolean z = view instanceof SimpleDraweeView;
        GenericDraweeHierarchyBuilder builder = z ? ((SimpleDraweeView) view).getHierarchy().getBuilder() : new GenericDraweeHierarchyBuilder(view.getResources());
        if (jDDisplayImageOptions.getColorFilter() != null) {
            builder.setActualImageColorFilter(jDDisplayImageOptions.getColorFilter());
        }
        builder.setFadeDuration(jDDisplayImageOptions.getFadeDurationMs());
        if (jDDisplayImageOptions.getRoundingParams() != null) {
            builder.setRoundingParams(jDDisplayImageOptions.getRoundingParams());
        }
        if (builder.getRoundingParams() != null) {
            builder.getRoundingParams().setPaintFilterBitmap(true);
        }
        Resources resources = Fresco.getContext().getResources();
        int placeholder = jDDisplayImageOptions.getPlaceholder();
        ScalingUtils.ScaleType scaleType = null;
        JDPlaceholderDrawable drawable3 = (placeholder <= 0 || placeholder > 23) ? placeholder != 0 ? resources.getDrawable(placeholder) : null : new JDPlaceholderDrawable(placeholder, builder.getRoundingParams());
        try {
            try {
                drawable = C1960b.m1056a(jDDisplayImageOptions.getImageOnLoading(resources));
            } catch (Throwable unused) {
            }
        } catch (Throwable unused2) {
            drawable = null;
        }
        try {
            try {
                drawable2 = C1960b.m1056a(jDDisplayImageOptions.getImageOnFail(resources));
            } catch (Throwable unused3) {
            }
        } catch (Throwable unused4) {
            drawable2 = null;
        }
        if (drawable3 == null) {
            drawable3 = new JDPlaceholderDrawable(17, builder.getRoundingParams());
        }
        if (view instanceof ImageView) {
            scaleType = C1957a.m1058a(((ImageView) view).getScaleType());
        }
        if (scaleType == null) {
            scaleType = ScalingUtils.ScaleType.FIT_CENTER;
        }
        if (jDDisplayImageOptions.getActualImageScaleType() != null) {
            builder.setActualImageScaleType(jDDisplayImageOptions.getActualImageScaleType());
        } else {
            builder.setActualImageScaleType(scaleType);
        }
        if (drawable2 != null) {
            builder.setFailureImage(drawable2, scaleType);
        } else if (jDDisplayImageOptions.isUsingDefaultPlaceholder()) {
            builder.setFailureImage((Drawable) drawable3, scaleType);
        }
        if (JdImageToolKit.getEngine().getImageControllerImpl().needNoImage()) {
            String string = JdImageToolKit.getEngine().getApplicationContext().getString(C0243R.string.image_need_long_click);
            if (!TextUtils.isEmpty(jDDisplayImageOptions.getNoImageText())) {
                string = jDDisplayImageOptions.getNoImageText();
            }
            builder.setFailureImage((Drawable) new ExceptionDrawable(string, jDDisplayImageOptions.getNoImageTextSize(), jDDisplayImageOptions.getNoImageTextGap()), scaleType);
        } else if (drawable != null) {
            builder.setPlaceholderImage(drawable, scaleType);
        } else if (jDDisplayImageOptions.isUsingDefaultPlaceholder()) {
            builder.setPlaceholderImage((Drawable) drawable3, scaleType);
        }
        GenericDraweeHierarchy build = builder.build();
        if (z) {
            build.setChangeImageListener(((SimpleDraweeView) view).getChangeImageListener());
        }
        return build;
    }

    /* renamed from: a */
    public static DraweeController m1044a(final View view, ImageRequest imageRequest, DraweeController draweeController, final JDDisplayImageOptions jDDisplayImageOptions, final ImageRequestListener<ImageInfo> imageRequestListener) {
        return Fresco.newDraweeControllerBuilder().setOldController(draweeController).setImageRequest(imageRequest).setControllerListener(new BaseControllerListener<ImageInfo>() { // from class: com.jd.mobile.image.b.a.4
            /* renamed from: a */
            public void onFinalImageSet(String str, @Nullable ImageInfo imageInfo, @Nullable Animatable animatable, Drawable drawable) {
                super.onFinalImageSet(str, imageInfo, animatable, drawable);
                if (imageInfo != null) {
                    C1957a.m1057a(imageInfo, view);
                    if (animatable != null) {
                        if (jDDisplayImageOptions.isTapToControlAnimationEnabled()) {
                            C1957a.m1059a(view, animatable);
                        }
                        if (jDDisplayImageOptions.getLoopCountOfAnimation() > 0) {
                            ((AnimatedDrawable2) animatable).setAnimationListener(new C1978a(jDDisplayImageOptions.getLoopCountOfAnimation()));
                        }
                    }
                    ImageRequestListener imageRequestListener2 = imageRequestListener;
                    if (imageRequestListener2 != null) {
                        imageRequestListener2.onSuccess(imageInfo);
                    }
                }
            }

            @Override // com.facebook.drawee.controller.BaseControllerListener, com.facebook.drawee.controller.ControllerListener
            public void onCancelled() {
                super.onCancelled();
                ImageRequestListener imageRequestListener2 = imageRequestListener;
                if (imageRequestListener2 != null) {
                    imageRequestListener2.onCancel();
                }
            }

            @Override // com.facebook.drawee.controller.BaseControllerListener, com.facebook.drawee.controller.ControllerListener
            public void onFailure(String str, Throwable th) {
                super.onFailure(str, th);
                ImageRequestListener imageRequestListener2 = imageRequestListener;
                if (imageRequestListener2 != null) {
                    imageRequestListener2.onFailure(th);
                }
            }
        }).setTapToRetryEnabled(false).setAutoPlayAnimations(true).build();
    }

    /* renamed from: a */
    private static ImageRequest m1049a(@NonNull Uri uri, JDDisplayImageOptions jDDisplayImageOptions) {
        ImageRequestBuilder c = m1038c(uri, jDDisplayImageOptions);
        if (c != null) {
            return c.build();
        }
        return null;
    }

    /* renamed from: a */
    public static ImageRequest m1041a(String str, JDDisplayImageOptions jDDisplayImageOptions) {
        if (TextUtils.isEmpty(str)) {
            str = "This string represent the uri is empty";
        }
        return m1049a(Uri.parse(str), jDDisplayImageOptions);
    }

    /* renamed from: a */
    public static void m1048a(Uri uri, JDDisplayImageOptions jDDisplayImageOptions, ImageRequestListener<EncodedImage> imageRequestListener) {
        if (uri != null) {
            if (jDDisplayImageOptions == null) {
                jDDisplayImageOptions = JDDisplayImageOptions.createSimple();
            }
            Fresco.getImagePipeline().fetchEncodedImage(m1040b(uri, jDDisplayImageOptions), null).subscribe(new 2(imageRequestListener), CallerThreadExecutor.getInstance());
        }
    }

    /* renamed from: a */
    public static void m1047a(Uri uri, JDDisplayImageOptions jDDisplayImageOptions, ImageRequestListener<Bitmap> imageRequestListener, Executor executor) {
        if (uri != null) {
            if (jDDisplayImageOptions == null) {
                jDDisplayImageOptions = JDDisplayImageOptions.createSimple();
            }
            Fresco.getImagePipeline().fetchDecodedImage(m1049a(uri, jDDisplayImageOptions), (Object) null, jDDisplayImageOptions.getImageRequestLevel()).subscribe(new 1(imageRequestListener), executor);
        }
    }

    /* renamed from: a */
    public static void m1046a(Uri uri, String str, AbstractC1956a aVar) {
        m1048a(uri, (JDDisplayImageOptions) null, new C1972a(str, aVar));
    }

    /* renamed from: a */
    public static void m1045a(View view, Uri uri, JDDisplayImageOptions jDDisplayImageOptions, ImageRequestListener<ImageInfo> imageRequestListener) {
        if (uri != null) {
            if (jDDisplayImageOptions == null) {
                jDDisplayImageOptions = JDDisplayImageOptions.createSimple();
            }
            if (jDDisplayImageOptions.getResizeOptions() == null && jDDisplayImageOptions.isScale()) {
                jDDisplayImageOptions.setResizeOptions(C1957a.m1060a(view));
            }
            ImageRequest a = m1049a(uri, jDDisplayImageOptions);
            GenericDraweeHierarchy a2 = m1043a(view, jDDisplayImageOptions);
            if (view instanceof SimpleDraweeView) {
                SimpleDraweeView simpleDraweeView = (SimpleDraweeView) view;
                simpleDraweeView.setHierarchy(a2);
                simpleDraweeView.setController(m1044a(view, a, simpleDraweeView.getController(), jDDisplayImageOptions, imageRequestListener));
                return;
            }
            DraweeHolder draweeHolder = (DraweeHolder) view.getTag(C0243R.C0245id.fresco_drawee);
            if (draweeHolder == null) {
                draweeHolder = DraweeHolder.create(a2, view.getContext());
            }
            draweeHolder.setController(m1044a(view, a, draweeHolder.getController(), jDDisplayImageOptions, imageRequestListener));
            if (ViewCompat.isAttachedToWindow(view)) {
                draweeHolder.onAttach();
            }
            View.OnAttachStateChangeListener onAttachStateChangeListener = (View$OnAttachStateChangeListenerC1979b) view.getTag(C0243R.C0245id.attach_change_listener);
            if (onAttachStateChangeListener == null) {
                onAttachStateChangeListener = new View$OnAttachStateChangeListenerC1979b(draweeHolder);
                view.addOnAttachStateChangeListener(onAttachStateChangeListener);
            }
            view.setTag(C0243R.C0245id.fresco_drawee, draweeHolder);
            view.setTag(C0243R.C0245id.attach_change_listener, onAttachStateChangeListener);
            if (view instanceof ImageView) {
                ((ImageView) view).setImageDrawable(draweeHolder.getTopLevelDrawable());
            } else if (Build.VERSION.SDK_INT >= 16) {
                view.setBackground(draweeHolder.getTopLevelDrawable());
            } else {
                view.setBackgroundDrawable(draweeHolder.getTopLevelDrawable());
            }
        }
    }

    /* renamed from: a */
    public static void m1042a(String str, ImageRequestListener<String> imageRequestListener) {
        Fresco.getImagePipeline().prefetchToDiskCache(m1039b(str, (JDDisplayImageOptions) null), null).subscribe(new 3(imageRequestListener, str), UiThreadImmediateExecutorService.getInstance());
    }

    /* renamed from: b */
    private static ImageRequest m1040b(@NonNull Uri uri, JDDisplayImageOptions jDDisplayImageOptions) {
        if (jDDisplayImageOptions == null) {
            jDDisplayImageOptions = JDDisplayImageOptions.createSimple();
        }
        return m1037d(uri, jDDisplayImageOptions).build();
    }

    /* renamed from: b */
    public static ImageRequest m1039b(String str, JDDisplayImageOptions jDDisplayImageOptions) {
        if (TextUtils.isEmpty(str)) {
            str = "This string represent the uri is empty";
        }
        return m1040b(Uri.parse(str), jDDisplayImageOptions);
    }

    /* renamed from: c */
    private static ImageRequestBuilder m1038c(@NonNull Uri uri, JDDisplayImageOptions jDDisplayImageOptions) {
        ImageRequestBuilder d = m1037d(uri, jDDisplayImageOptions);
        d.setRotationOptions(jDDisplayImageOptions.isConsiderExifParams() ? RotationOptions.autoRotate() : RotationOptions.disableRotation());
        d.setIsUseThumbnail(jDDisplayImageOptions.isUseThumbnail());
        if (!jDDisplayImageOptions.isCacheOnDisk()) {
            d.disableDiskCache();
        }
        if (!jDDisplayImageOptions.isCacheInMemory()) {
            d.disableMemoryCache();
        }
        d.setResizeOptions(jDDisplayImageOptions.getResizeOptions());
        d.setPostprocessor(jDDisplayImageOptions.getPostProcessor());
        ImageDecodeOptionsBuilder bitmapConfig = ImageDecodeOptions.newBuilder().setBitmapConfig(Bitmap.Config.RGB_565);
        if (jDDisplayImageOptions.getBitmapConfig() != null) {
            bitmapConfig.setBitmapConfig(jDDisplayImageOptions.getBitmapConfig());
        }
        if (jDDisplayImageOptions.isUsingJavaGifDecoder()) {
            bitmapConfig.setCustomImageDecoder(new GifDecoder());
        }
        if (jDDisplayImageOptions.isForceStaticImage()) {
            bitmapConfig.setForceStaticImage(true);
        }
        d.setImageDecodeOptions(bitmapConfig.build());
        if (jDDisplayImageOptions.getNetworkImageRequestListener() != null) {
            d.setRequestListener(jDDisplayImageOptions.getNetworkImageRequestListener());
        }
        ImageRequest build = d.build();
        build.setForce2HttpFlag(JdImageToolKit.getEngine().getNetworkParameterImpl().isForce2HttpFlag());
        build.setUseDomainFlag(JdImageToolKit.getEngine().getNetworkParameterImpl().isUseDomainFlag());
        return d;
    }

    /* renamed from: d */
    private static ImageRequestBuilder m1037d(@NonNull Uri uri, JDDisplayImageOptions jDDisplayImageOptions) {
        return ImageRequestBuilder.newBuilderWithSource(uri).setLowestPermittedRequestLevel(jDDisplayImageOptions.getImageRequestLevel());
    }
}
