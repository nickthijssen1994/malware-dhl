package com.p051jd.libs.hybrid.offlineload.loader;

import android.content.Context;
import android.text.TextUtils;
import com.jd.libs.hybrid.offlineload.entity.CommonEntity;
import com.p051jd.framework.network.JDResponse;
import com.p051jd.framework.network.error.JDError;
import com.p051jd.hybrid.downloader.C1545a;
import com.p051jd.hybrid.downloader.C1551b;
import com.p051jd.hybrid.downloader.C1556c;
import com.p051jd.hybrid.downloader.p081b.C1554a;
import com.p051jd.libs.hybrid.base.C1841a;
import com.p051jd.libs.hybrid.base.p095b.C1848a;
import com.p051jd.libs.hybrid.base.p095b.C1853c;
import com.p051jd.libs.hybrid.offlineload.C1861a;
import com.p051jd.libs.hybrid.offlineload.entity.FileDetail;
import com.p051jd.libs.hybrid.offlineload.p096a.C1864a;
import com.p051jd.libs.hybrid.offlineload.p096a.C1866c;
import com.p051jd.libs.hybrid.offlineload.p097db.AbstractC1876a;
import com.p051jd.libs.hybrid.offlineload.p097db.CommonFileDatabase;
import java.io.File;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Random;

/* renamed from: com.jd.libs.hybrid.offlineload.loader.a */
/* loaded from: classes.dex */
public final class C1892a {

    /* renamed from: a */
    final Context f3263a;

    /* renamed from: b */
    final AbstractC1876a f3264b;

    /* renamed from: com.jd.libs.hybrid.offlineload.loader.a$a */
    /* loaded from: classes.dex */
    class C1897a extends C1545a {

        /* renamed from: b */
        private final CommonEntity f3273b;

        /* renamed from: c */
        private final int f3274c;

        C1897a(CommonEntity commonEntity, int i) {
            this.f3273b = commonEntity;
            this.f3274c = i;
        }

        @Override // com.p051jd.hybrid.downloader.C1545a, com.p051jd.framework.network.JDResponseListener
        public final void onEnd(JDResponse<File> jDResponse) {
            final File data = jDResponse.getData();
            final Map<String, String> headers = jDResponse.getHeaders();
            C1848a.m1322a().m1321b().execute(new Runnable() { // from class: com.jd.libs.hybrid.offlineload.loader.a.a.1
                @Override // java.lang.Runnable
                public final void run() {
                    C1897a.this.f3273b.setFileDetail(new FileDetail(data));
                    C1897a.this.f3273b.setHeadersMap(headers);
                    try {
                        C1897a.this.f3273b.setAvailable(true);
                        C1892a.this.f3264b.mo1218a(C1897a.this.f3273b);
                        if (C1853c.m1317a()) {
                            C1853c.m1309b("CommonFileService", null, "公共资源(" + C1897a.this.f3273b.getUrl() + ")下载完毕，已可用。");
                            C1853c.m1308c("CommonFileService", "[Common-file] Download and update config success, file at " + data.getAbsolutePath() + ", url = " + C1897a.this.f3273b.getUrl());
                        }
                    } catch (Exception e) {
                        C1853c.m1306e("CommonFileService", e.getMessage());
                    }
                }
            });
        }

        @Override // com.p051jd.hybrid.downloader.C1545a, com.p051jd.framework.network.JDResponseListener
        public final void onError(JDError jDError) {
            String str;
            String str2;
            if (this.f3274c < C1841a.f3186f) {
                if (C1853c.m1317a()) {
                    StringBuilder sb = new StringBuilder("公共资源(");
                    sb.append(this.f3273b.getUrl());
                    sb.append(")下载失败，加入重试列表。");
                    if (jDError != null) {
                        str2 = "原因:code = " + jDError.getStatusCode() + ", msg = " + jDError.getMessage();
                    } else {
                        str2 = "";
                    }
                    sb.append(str2);
                    C1853c.m1309b("CommonFileService", null, sb.toString());
                }
                C1892a.m1196a(C1892a.this, this.f3273b, this.f3274c + 1);
                C1909c.m1176c(this.f3273b);
                return;
            }
            if (C1853c.m1317a()) {
                StringBuilder sb2 = new StringBuilder("公共资源(");
                sb2.append(this.f3273b.getUrl());
                sb2.append(")下载失败。");
                if (jDError != null) {
                    str = "原因:code = " + jDError.getStatusCode() + ", msg = " + jDError.getMessage();
                } else {
                    str = "";
                }
                sb2.append(str);
                C1853c.m1309b("CommonFileService", null, sb2.toString());
            }
            C1909c.m1177b(this.f3273b);
            C1864a.m1278a(C1892a.this.f3263a, this.f3273b);
        }
    }

    public C1892a(Context context) {
        this.f3263a = context;
        this.f3264b = CommonFileDatabase.m1239a(context).mo1238a();
    }

    /* renamed from: a */
    static /* synthetic */ List m1197a(C1861a.C1863b bVar) {
        ArrayList<CommonEntity> arrayList;
        String str;
        StringBuilder sb;
        int i = 0;
        int size = bVar.f3212a != null ? bVar.f3212a.size() : 0;
        if (bVar.f3213b != null) {
            i = bVar.f3213b.size();
        }
        if (size > 0 || i > 0) {
            arrayList = new ArrayList(size + i);
            if (size > 0) {
                arrayList.addAll(bVar.f3212a);
            }
            if (i > 0) {
                arrayList.addAll(bVar.f3213b);
            }
        } else {
            arrayList = null;
        }
        if (arrayList == null || arrayList.isEmpty()) {
            C1853c.m1308c("CommonFileService", "[Common-file] final config list is empty, no need to download.");
            return null;
        }
        ArrayList arrayList2 = new ArrayList();
        for (CommonEntity commonEntity : arrayList) {
            if (!commonEntity.isAvailable()) {
                if (!C1909c.m1178a(commonEntity)) {
                    arrayList2.add(commonEntity);
                    if (C1841a.m1346b()) {
                        str = "CommonFileService";
                        sb = new StringBuilder("[Common-file] Need to download, url: ");
                        sb.append(commonEntity.getUrl());
                        C1853c.m1308c(str, sb.toString());
                    }
                } else if (C1841a.m1346b()) {
                    str = "CommonFileService";
                    sb = new StringBuilder("[Common-file] Need to download but it has exceed the max retry count, url: ");
                    sb.append(commonEntity.getUrl());
                    C1853c.m1308c(str, sb.toString());
                }
            } else if (C1841a.m1346b()) {
                str = "CommonFileService";
                sb = new StringBuilder("[Common-file] Do nothing for existed common file, url: ");
                sb.append(commonEntity.getUrl());
                C1853c.m1308c(str, sb.toString());
            }
        }
        return arrayList2;
    }

    /* renamed from: a */
    static /* synthetic */ void m1196a(C1892a aVar, CommonEntity commonEntity, int i) {
        aVar.m1194a(Collections.singletonList(commonEntity), i);
    }

    /* JADX INFO: Access modifiers changed from: private */
    /* renamed from: a */
    public void m1194a(List<CommonEntity> list, int i) {
        int lastIndexOf;
        C1551b a = C1551b.m1575a();
        if (a != null) {
            ArrayList arrayList = new ArrayList(list.size());
            for (CommonEntity commonEntity : list) {
                String url = commonEntity.getUrl();
                String str = "公共资源(" + url + ")";
                String str2 = "hybrid/.preload/.common" + File.separator + "." + commonEntity.getId();
                String substring = (url.endsWith("/") || -1 == (lastIndexOf = url.lastIndexOf("/"))) ? "" : url.substring(lastIndexOf + 1);
                if (TextUtils.isEmpty(substring)) {
                    substring = C1866c.m1275a();
                }
                C1556c cVar = new C1556c(str, url, str2, (System.currentTimeMillis() + ((long) new Random().nextInt(1000))) + "_" + substring, true, Integer.MAX_VALUE);
                cVar.m1564a(0);
                cVar.m1562a(new C1554a(commonEntity.getMd5()));
                cVar.m1563a(new C1897a(commonEntity, i));
                arrayList.add(cVar);
            }
            a.m1570a(arrayList, true);
        }
    }
}
