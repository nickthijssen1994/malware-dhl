package com.facebook.animated.giflite;

import android.graphics.Movie;
import com.facebook.animated.giflite.decoder.GifMetadataDecoder;
import com.facebook.animated.giflite.draw.MovieAnimatedImage;
import com.facebook.animated.giflite.draw.MovieDrawer;
import com.facebook.animated.giflite.draw.MovieFrame;
import com.facebook.imagepipeline.animated.base.AnimatedDrawableFrameInfo;
import com.facebook.imagepipeline.animated.base.AnimatedImageResult;
import com.facebook.imagepipeline.common.ImageDecodeOptions;
import com.facebook.imagepipeline.decoder.ImageDecoder;
import com.facebook.imagepipeline.image.CloseableAnimatedImage;
import com.facebook.imagepipeline.image.CloseableImage;
import com.facebook.imagepipeline.image.EncodedImage;
import com.facebook.imagepipeline.image.QualityInfo;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;

/* loaded from: classes.dex */
public class GifDecoder implements ImageDecoder {
    private static AnimatedDrawableFrameInfo.DisposalMethod translateFrameDisposal(int i) {
        switch (i) {
            case 2:
                return AnimatedDrawableFrameInfo.DisposalMethod.DISPOSE_TO_BACKGROUND;
            case 3:
                return AnimatedDrawableFrameInfo.DisposalMethod.DISPOSE_TO_PREVIOUS;
            default:
                return AnimatedDrawableFrameInfo.DisposalMethod.DISPOSE_DO_NOT;
        }
    }

    @Override // com.facebook.imagepipeline.decoder.ImageDecoder
    public CloseableImage decode(EncodedImage encodedImage, int i, QualityInfo qualityInfo, ImageDecodeOptions imageDecodeOptions) {
        InputStream inputStream;
        try {
            inputStream = encodedImage.getInputStream();
            try {
                ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
                GifMetadataDecoder create = GifMetadataDecoder.create(inputStream, byteArrayOutputStream);
                if (byteArrayOutputStream.size() > 0) {
                    inputStream.close();
                    inputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());
                }
                inputStream.reset();
                Movie decodeStream = Movie.decodeStream(inputStream);
                MovieDrawer movieDrawer = new MovieDrawer(decodeStream);
                MovieFrame[] movieFrameArr = new MovieFrame[create.getFrameCount()];
                int length = movieFrameArr.length;
                int i2 = 0;
                int i3 = 0;
                while (i3 < length) {
                    int frameDurationMs = create.getFrameDurationMs(i3);
                    int i4 = i2 + frameDurationMs;
                    movieFrameArr[i3] = new MovieFrame(movieDrawer, i4, frameDurationMs, decodeStream.width(), decodeStream.height(), translateFrameDisposal(create.getFrameDisposal(i3)));
                    i3++;
                    i2 = i4;
                }
                CloseableAnimatedImage closeableAnimatedImage = new CloseableAnimatedImage(AnimatedImageResult.forAnimatedImage(new MovieAnimatedImage(movieFrameArr, encodedImage.getSize(), decodeStream.duration(), create.getLoopCount())), false);
                try {
                    inputStream.close();
                } catch (IOException unused) {
                }
                return closeableAnimatedImage;
            } catch (IOException e) {
                throw new RuntimeException("Error while decoding gif", e);
            }
        } catch (Throwable th) {
            try {
                inputStream.close();
            } catch (IOException unused2) {
            }
            throw th;
        }
    }
}
