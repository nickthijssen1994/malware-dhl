package com.huawei.updatesdk.service.otaupdate;

import android.app.Activity;
import android.content.ActivityNotFoundException;
import android.content.Context;
import android.content.Intent;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageInfo;
import android.os.AsyncTask;
import android.os.BaseBundle;
import android.os.Bundle;
import android.text.TextUtils;
import android.widget.Toast;
import com.huawei.updatesdk.a.b.d.c.d;
import com.huawei.updatesdk.org.android.asm.util.Label;
import com.huawei.updatesdk.service.appmgr.bean.ApkUpgradeInfo;
import com.huawei.updatesdk.service.appmgr.bean.LayoutManager;
import com.huawei.updatesdk.service.appmgr.bean.c;
import com.huawei.updatesdk.text.http.HttpURLConnectionImpl;
import com.huawei.updatesdk.text.hyphenation.b;
import com.huawei.updatesdk.text.speech.tts.ByteVector;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

public class MethodWriter
  extends AsyncTask<Void, Void, d>
{
  private Toast a;
  private Context c;
  private com.huawei.updatesdk.org.shared.book.f d;
  private String h;
  private CheckUpdateCallBack o;
  private List<String> q = new ArrayList();
  private boolean w = false;
  private UpdateParams x;
  
  public MethodWriter(Context paramContext, UpdateParams paramUpdateParams, CheckUpdateCallBack paramCheckUpdateCallBack)
  {
    x = paramUpdateParams;
    c = paramContext;
    o = paramCheckUpdateCallBack;
    Frame.get().set(paramUpdateParams.getServiceZone());
    if (TextUtils.isEmpty(Frame.get().getValue())) {
      Frame.get().a("com.huawei.appmarket");
    }
    h = Frame.get().getValue();
  }
  
  private PackageInfo a(Context paramContext, String paramString)
  {
    PackageInfo localPackageInfo = b.onCreateView(paramString, paramContext);
    paramContext = localPackageInfo;
    if (localPackageInfo == null)
    {
      paramContext = new PackageInfo();
      packageName = paramString;
      versionName = "1.0";
      versionCode = 1;
      paramString = new ApplicationInfo();
      targetSdkVersion = 19;
      applicationInfo = paramString;
    }
    return paramContext;
  }
  
  private com.huawei.updatesdk.org.shared.book.util.Item a(Context paramContext, List paramList)
  {
    ArrayList localArrayList = new ArrayList();
    paramList = paramList.iterator();
    while (paramList.hasNext()) {
      localArrayList.add(a(paramContext, (String)paramList.next()));
    }
    if (!Item.a(x.getParamList())) {
      paramContext = new LayoutManager(x.getParamList());
    } else {
      paramContext = LayoutManager.init(localArrayList);
    }
    int i;
    if (Frame.get().a()) {
      i = 34;
    } else {
      i = 0;
    }
    paramContext.read(i);
    paramContext.layout(0);
    if (isCancelled())
    {
      android.util.Log.w("UpdateSDKCheckTask", "UpdateSDK task is canceled and return empty upgradeInfo");
      return null;
    }
    d = new com.huawei.updatesdk.org.shared.book.f(paramContext, null);
    return d.b();
  }
  
  private void a(Context paramContext, ApkUpgradeInfo paramApkUpgradeInfo)
  {
    if (paramContext == null) {
      return;
    }
    Intent localIntent = new Intent(paramContext, AppUpdateActivity.class);
    Bundle localBundle = new Bundle();
    localBundle.putSerializable("app_update_parm", paramApkUpgradeInfo);
    localBundle.putBoolean("app_must_btn", x.isMustBtnOne());
    localIntent.putExtras(localBundle);
    if (!(paramContext instanceof Activity)) {
      localIntent.setFlags(268435456);
    }
    try
    {
      paramContext.startActivity(localIntent);
      return;
    }
    catch (ActivityNotFoundException paramContext)
    {
      paramApkUpgradeInfo = new StringBuilder();
      paramApkUpgradeInfo.append("go AppUpdateActivity error: ");
      paramApkUpgradeInfo.append(paramContext.toString());
      com.huawei.updatesdk.org.android.remote.calendar.widget.Log.append("UpdateSDKCheckTask", paramApkUpgradeInfo.toString());
    }
  }
  
  private void b(com.huawei.updatesdk.org.shared.book.util.Item paramItem)
  {
    if (o != null)
    {
      Intent localIntent = new Intent();
      localIntent.putExtra("status", 6);
      if (paramItem.getKey() != null) {
        localIntent.putExtra("failcause", paramItem.getKey().ordinal());
      }
      localIntent.putExtra("failreason", paramItem.substring());
      localIntent.putExtra("responsecode", paramItem.c());
      o.onUpdateInfo(localIntent);
      o.onUpdateStoreError(paramItem.a());
    }
  }
  
  private void c(List paramList)
  {
    if (Item.a(paramList)) {
      return;
    }
    paramList = paramList.iterator();
    while (paramList.hasNext())
    {
      ApkUpgradeInfo localApkUpgradeInfo = (ApkUpgradeInfo)paramList.next();
      if ((localApkUpgradeInfo != null) && (!TextUtils.isEmpty(localApkUpgradeInfo.getFullDownUrl_())))
      {
        if (localApkUpgradeInfo.getDiffSize_() > 0) {
          localApkUpgradeInfo.setDiffDownUrl_(localApkUpgradeInfo.getDownurl_());
        }
        localApkUpgradeInfo.setDownurl_(localApkUpgradeInfo.getFullDownUrl_());
      }
    }
  }
  
  private boolean c()
  {
    return (!w) && (TextUtils.isEmpty(x.getTargetPkgName())) && (Item.a(x.getPackageList())) && (Item.a(x.getParamList()));
  }
  
  private void d()
  {
    Toast localToast = a;
    if (localToast != null) {
      localToast.cancel();
    }
  }
  
  protected com.huawei.updatesdk.org.shared.book.util.Item a(Void... paramVarArgs)
  {
    com.huawei.updatesdk.org.android.remote.calendar.widget.Log.e("UpdateSDKCheckTask", "CheckOtaAndUpdataTask doInBackground");
    ByteVector.write(this);
    Frame.get().a(c, h);
    Object localObject = c;
    if (Frame.get().a()) {
      paramVarArgs = "upsdk_apptouch_store_url";
    } else {
      paramVarArgs = "upsdk_store_url";
    }
    paramVarArgs = h.a((Context)localObject, paramVarArgs);
    com.huawei.updatesdk.org.shared.book.util.Frame.b(Label.b(c, paramVarArgs));
    localObject = x.getTargetPkgName();
    paramVarArgs = (Void[])localObject;
    if (TextUtils.isEmpty((CharSequence)localObject)) {
      paramVarArgs = c.getPackageName();
    }
    if (Item.a(x.getPackageList()))
    {
      if (!TextUtils.isEmpty(paramVarArgs)) {
        q.add(paramVarArgs);
      }
    }
    else {
      q.addAll(x.getPackageList());
    }
    com.huawei.updatesdk.text.http.f.a().b(Frame.get().b());
    return a(c, q);
  }
  
  protected void a(com.huawei.updatesdk.org.shared.book.util.Item paramItem)
  {
    ByteVector.get().remove(this);
    d();
    if (paramItem == null)
    {
      if (o != null)
      {
        paramItem = new Intent();
        paramItem.putExtra("status", 3);
        o.onUpdateInfo(paramItem);
      }
    }
    else
    {
      int i = paramItem.c();
      Object localObject1 = null;
      Object localObject2;
      if ((paramItem.a() == 0) && (paramItem.getId() == 0))
      {
        paramItem = (c)paramItem;
        localObject1 = list_;
        if (!Item.a(notRcmList_))
        {
          paramItem = (ApkUpgradeInfo)notRcmList_.get(0);
          localObject2 = new StringBuilder();
          ((StringBuilder)localObject2).append("UpdateSDK get update info is not recommend,reason: ");
          ((StringBuilder)localObject2).append(paramItem.getNotRcmReason_());
          ((StringBuilder)localObject2).append(",is same signature: ");
          ((StringBuilder)localObject2).append(paramItem.getSameS_());
          android.util.Log.w("UpdateSDKCheckTask", ((StringBuilder)localObject2).toString());
        }
        c((List)localObject1);
        paramItem = (com.huawei.updatesdk.org.shared.book.util.Item)localObject1;
        if (Item.a((List)localObject1))
        {
          paramItem = (com.huawei.updatesdk.org.shared.book.util.Item)localObject1;
          if (o != null)
          {
            paramItem = new Intent();
            paramItem.putExtra("status", 3);
            paramItem.putExtra("responsecode", i);
            o.onUpdateInfo(paramItem);
            paramItem = (com.huawei.updatesdk.org.shared.book.util.Item)localObject1;
          }
        }
      }
      else
      {
        b(paramItem);
        localObject2 = new StringBuilder();
        ((StringBuilder)localObject2).append("get app update msg failed,responseCode is ");
        ((StringBuilder)localObject2).append(paramItem.a());
        ((StringBuilder)localObject2).append(",failreason: ");
        ((StringBuilder)localObject2).append(paramItem.substring());
        android.util.Log.e("UpdateSDKCheckTask", ((StringBuilder)localObject2).toString());
        paramItem = (com.huawei.updatesdk.org.shared.book.util.Item)localObject1;
      }
      if (!Item.a(paramItem))
      {
        localObject1 = (ApkUpgradeInfo)paramItem.get(0);
        if (o != null)
        {
          localObject2 = new Intent();
          ((Intent)localObject2).putExtra("updatesdk_update_info", (Serializable)localObject1);
          ((Intent)localObject2).putParcelableArrayListExtra("updatesdk_update_info_list", paramItem);
          ((Intent)localObject2).putExtra("status", 7);
          ((Intent)localObject2).putExtra("responsecode", i);
          o.onUpdateInfo((Intent)localObject2);
        }
        if (localObject1 != null)
        {
          paramItem = new StringBuilder();
          paramItem.append("ApkUpgradeInfo,version = ");
          paramItem.append(((ApkUpgradeInfo)localObject1).getVersion_());
          paramItem.append(",versionCode = ");
          paramItem.append(((ApkUpgradeInfo)localObject1).getVersionCode_());
          paramItem.append(",detailId = ");
          paramItem.append(((ApkUpgradeInfo)localObject1).getDetailId_());
          paramItem.append(",devType = ");
          paramItem.append(((ApkUpgradeInfo)localObject1).getDevType_());
          paramItem.append(",packageName = ");
          paramItem.append(((ApkUpgradeInfo)localObject1).getPackage_());
          paramItem.append(",oldVersionCode = ");
          paramItem.append(((ApkUpgradeInfo)localObject1).getOldVersionCode_());
          android.util.Log.i("UpdateSDKCheckTask", paramItem.toString());
        }
        else
        {
          android.util.Log.e("UpdateSDKCheckTask", "info == null");
        }
        if (x.isShowImmediate()) {
          a(c, (ApkUpgradeInfo)localObject1);
        }
      }
      else if (c())
      {
        paramItem = c;
        Toast.makeText(paramItem, h.getString(paramItem, "upsdk_update_check_no_new_version"), 0).show();
      }
    }
  }
  
  public void b(boolean paramBoolean)
  {
    w = paramBoolean;
  }
  
  protected void onCancelled()
  {
    super.onCancelled();
    com.huawei.updatesdk.org.shared.book.f localF = d;
    if (localF != null) {
      localF.c();
    }
  }
  
  protected void onPreExecute()
  {
    super.onPreExecute();
    f.a().a(o);
    if (c())
    {
      Context localContext = c;
      a = Toast.makeText(localContext, h.getString(localContext, "upsdk_checking_update_prompt"), 1);
      a.show();
    }
  }
}
