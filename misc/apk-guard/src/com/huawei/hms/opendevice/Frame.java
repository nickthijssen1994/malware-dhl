package com.huawei.hms.opendevice;

import android.content.Context;
import android.text.TextUtils;
import com.huawei.hms.aaid.HmsInstanceId;
import com.huawei.hms.aaid.constant.ErrorEnum;
import com.huawei.hms.aaid.entity.TokenReq;
import com.huawei.hms.aaid.entity.TokenResp;
import com.huawei.hms.aaid.entity.TokenResult;
import com.huawei.hms.aaid.task.PushClient;
import com.huawei.hms.common.ApiException;
import com.huawei.hms.common.internal.BaseHmsClient;
import com.huawei.hms.common.internal.ResponseErrorCode;
import com.huawei.hms.common.internal.TaskApiCall;
import com.huawei.hms.support.model.HMSLog;
import com.huawei.hms.support.mozilla.client.Status;
import com.huawei.hms.utils.JsonUtil;
import com.huawei.provider.tasks.TaskCompletionSource;

public class Frame
  extends TaskApiCall<PushClient, TokenResult>
{
  public Context c;
  public TokenReq i;
  
  public Frame(String paramString1, TokenReq paramTokenReq, Context paramContext, String paramString2)
  {
    super(paramString1, JsonUtil.createJsonString(paramTokenReq), paramString2);
    c = paramContext;
    i = paramTokenReq;
  }
  
  public final void b(String paramString1, String paramString2)
  {
    if (!ClassWriter.a(c).get(paramString2).equals(paramString1))
    {
      HMSLog.append(HmsInstanceId.i, "receive a token, refresh the local token");
      ClassWriter.a(c).a(paramString2, paramString1);
    }
  }
  
  public void c(PushClient paramPushClient, ResponseErrorCode paramResponseErrorCode, String paramString, TaskCompletionSource paramTaskCompletionSource)
  {
    Object localObject;
    if (paramResponseErrorCode.getErrorCode() != 0)
    {
      paramString = HmsInstanceId.i;
      localObject = new StringBuilder();
      ((StringBuilder)localObject).append("TokenTask failed, ErrorCode: ");
      ((StringBuilder)localObject).append(paramResponseErrorCode.getErrorCode());
      HMSLog.toString(paramString, ((StringBuilder)localObject).toString());
      paramString = ErrorEnum.fromCode(paramResponseErrorCode.getErrorCode());
      if (paramString != ErrorEnum.ERROR_UNKNOWN) {
        paramTaskCompletionSource.setException(paramString.toApiException());
      } else {
        paramTaskCompletionSource.setException(new ApiException(new Status(paramResponseErrorCode.getErrorCode(), paramResponseErrorCode.getErrorReason())));
      }
    }
    else
    {
      localObject = (TokenResp)JsonUtil.jsonToEntity(paramString, new TokenResp());
      paramString = ErrorEnum.fromCode(((TokenResp)localObject).getRetCode());
      if (paramString != ErrorEnum.SUCCESS)
      {
        paramTaskCompletionSource.setException(paramString.toApiException());
        paramTaskCompletionSource = HmsInstanceId.i;
        localObject = new StringBuilder();
        ((StringBuilder)localObject).append("TokenTask failed, StatusCode:");
        ((StringBuilder)localObject).append(paramString.getExternalCode());
        HMSLog.toString(paramTaskCompletionSource, ((StringBuilder)localObject).toString());
      }
      else
      {
        paramString = new TokenResult();
        paramString.setToken(((TokenResp)localObject).getToken());
        paramString.setBelongId(((TokenResp)localObject).getBelongId());
        paramString.setRetCode(ErrorEnum.fromCode(((TokenResp)localObject).getRetCode()).getExternalCode());
        paramTaskCompletionSource.setResult(paramString);
        paramString = ((TokenResp)localObject).getToken();
        if (TextUtils.isEmpty(paramString))
        {
          HMSLog.append(HmsInstanceId.i, "GetTokenTask receive a empty token, please check HmsMessageService.onNewToken receive result.");
          JSONArray.toString(paramPushClient.getContext(), getUri(), paramResponseErrorCode);
          return;
        }
        b(paramString, i.getSubjectId());
        g.a(c, paramString);
      }
    }
    JSONArray.toString(paramPushClient.getContext(), getUri(), paramResponseErrorCode);
  }
  
  public int getMinApkVersion()
  {
    if (i.isMultiSender()) {
      return 50004300;
    }
    return 30000000;
  }
}
