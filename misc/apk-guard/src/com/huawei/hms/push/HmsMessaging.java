package com.huawei.hms.push;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Parcelable;
import android.text.TextUtils;
import com.huawei.hms.aaid.constant.ErrorEnum;
import com.huawei.hms.aaid.encrypt.PushEncrypter;
import com.huawei.hms.aaid.init.AutoInitHelper;
import com.huawei.hms.aaid.plugin.ProxyCenter;
import com.huawei.hms.aaid.plugin.PushProxy;
import com.huawei.hms.aaid.task.PushClientBuilder;
import com.huawei.hms.aaid.utils.BaseUtils;
import com.huawei.hms.aaid.utils.PushPreferences;
import com.huawei.hms.android.HwBuildEx.VERSION;
import com.huawei.hms.api.Api.ApiOptions.NoOptions;
import com.huawei.hms.common.ApiException;
import com.huawei.hms.common.HuaweiApi;
import com.huawei.hms.common.internal.Preconditions;
import com.huawei.hms.configurations.TermSession;
import com.huawei.hms.core.aidl.IMessageEntity;
import com.huawei.hms.push.task.BaseVoidTask;
import com.huawei.hms.push.task.IntentCallable;
import com.huawei.hms.push.task.SendUpStreamTask;
import com.huawei.hms.push.task.SubscribeTask;
import com.huawei.hms.push.utils.PushBiUtil;
import com.huawei.hms.support.model.HMSLog;
import com.huawei.hms.support.mozilla.entity.push.EnableNotifyReq;
import com.huawei.hms.support.mozilla.entity.push.SubscribeReq;
import com.huawei.hms.support.mozilla.entity.push.UpSendMsgReq;
import com.huawei.hms.support.mozilla.push.utils.CommFun;
import com.huawei.hms.utils.JsonUtil;
import com.huawei.hms.utils.NetWorkUtil;
import com.huawei.provider.tasks.Task;
import com.huawei.provider.tasks.TaskCompletionSource;
import com.huawei.provider.tasks.Tasks;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class HmsMessaging
{
  public static final Pattern DATE_DELIMITER = Pattern.compile("[\\u4e00-\\u9fa5\\w-_.~%]{1,900}");
  public static final String DEFAULT_TOKEN_SCOPE = "HCM";
  public Context sslContext;
  public HuaweiApi<Api.ApiOptions.NoOptions> this$0;
  
  public HmsMessaging(Context paramContext)
  {
    Preconditions.checkNotNull(paramContext);
    sslContext = paramContext;
    TermSession localTermSession = new TermSession("HuaweiPush.API");
    if ((paramContext instanceof Activity)) {
      this$0 = new HuaweiApi((Activity)paramContext, localTermSession, null, new PushClientBuilder());
    } else {
      this$0 = new HuaweiApi(paramContext, localTermSession, null, new PushClientBuilder());
    }
    this$0.setKitSdkVersion(50004300);
  }
  
  public static HmsMessaging getInstance(Context paramContext)
  {
    try
    {
      paramContext = new HmsMessaging(paramContext);
      return paramContext;
    }
    catch (Throwable paramContext)
    {
      throw paramContext;
    }
  }
  
  public boolean isAutoInitEnabled()
  {
    return AutoInitHelper.isAutoInitEnabled(sslContext);
  }
  
  public final Task processResponse(String paramString1, String paramString2)
  {
    str = PushBiUtil.reportEntry(sslContext, "push.subscribe");
    Object localObject;
    if ((paramString1 != null) && (DATE_DELIMITER.matcher(paramString1).matches()))
    {
      if (ProxyCenter.getProxy() != null)
      {
        HMSLog.append("HmsMessaging", "use proxy subscribe.");
        if (TextUtils.equals(paramString2, "Sub")) {
          return ProxyCenter.getProxy().subscribe(sslContext, paramString1, str);
        }
        return ProxyCenter.getProxy().unsubscribe(sslContext, paramString1, str);
      }
      localObject = sslContext;
    }
    try
    {
      localObject = Route.getProxy((Context)localObject);
      if (localObject == ErrorEnum.SUCCESS)
      {
        localObject = sslContext;
        int i = NetWorkUtil.getNetworkType((Context)localObject);
        if (i != 0)
        {
          localObject = sslContext;
          paramString1 = new SubscribeReq((Context)localObject, paramString2, paramString1);
          paramString2 = sslContext;
          paramString1.setToken(BaseUtils.getLocalToken(paramString2, null));
          boolean bool = CommFun.isEmui10Plus();
          if (bool) {
            paramString2 = this$0;
          }
        }
      }
    }
    catch (ApiException paramString1)
    {
      paramString2 = new TaskCompletionSource();
      paramString2.setException(paramString1);
      PushBiUtil.reportExit(sslContext, "push.subscribe", str, paramString1.getStatusCode());
      return paramString2.getTask();
      PushBiUtil.reportExit(sslContext, "push.subscribe", str, ErrorEnum.ERROR_ARGUMENTS_INVALID);
      HMSLog.toString("HmsMessaging", "Invalid topic: topic should match the format:[\\u4e00-\\u9fa5\\w-_.~%]{1,900}");
      throw new IllegalArgumentException("Invalid topic: topic should match the format:[\\u4e00-\\u9fa5\\w-_.~%]{1,900}");
    }
    catch (Exception paramString1)
    {
      for (;;) {}
    }
    try
    {
      paramString1 = paramString2.doWrite(new BaseVoidTask("push.subscribe", JsonUtil.createJsonString(paramString1), str));
      return paramString1;
    }
    catch (Exception paramString1)
    {
      break label241;
    }
    paramString2 = this$0;
    try
    {
      paramString1 = paramString2.doWrite(new SubscribeTask("push.subscribe", JsonUtil.createJsonString(paramString1), str));
      return paramString1;
    }
    catch (Exception paramString1)
    {
      label241:
      for (;;) {}
    }
    try
    {
      HMSLog.toString("HmsMessaging", "no network");
      paramString1 = ErrorEnum.ERROR_NO_NETWORK;
      paramString1 = paramString1.toApiException();
      throw paramString1;
    }
    catch (Exception paramString1)
    {
      break label241;
    }
    paramString1 = ((ErrorEnum)localObject).toApiException();
    throw paramString1;
    paramString1 = new TaskCompletionSource();
    paramString1.setException(ErrorEnum.ERROR_INTERNAL_ERROR.toApiException());
    PushBiUtil.reportExit(sslContext, "push.subscribe", str, ErrorEnum.ERROR_INTERNAL_ERROR);
    return paramString1.getTask();
  }
  
  public final void processResponse(RemoteMessage paramRemoteMessage)
  {
    String str = PushBiUtil.reportEntry(sslContext, "push.sendMessage");
    Object localObject = Route.getProxy(sslContext);
    if (localObject == ErrorEnum.SUCCESS)
    {
      if (!TextUtils.isEmpty(paramRemoteMessage.getTo()))
      {
        if (!TextUtils.isEmpty(paramRemoteMessage.getMessageId()))
        {
          if (!TextUtils.isEmpty(paramRemoteMessage.getData()))
          {
            localObject = new UpSendMsgReq();
            ((UpSendMsgReq)localObject).setPackageName(sslContext.getPackageName());
            ((UpSendMsgReq)localObject).setMessageId(paramRemoteMessage.getMessageId());
            ((UpSendMsgReq)localObject).setTo(paramRemoteMessage.getTo());
            ((UpSendMsgReq)localObject).setData(paramRemoteMessage.getData());
            ((UpSendMsgReq)localObject).setMessageType(paramRemoteMessage.getMessageType());
            ((UpSendMsgReq)localObject).setTtl(paramRemoteMessage.getTtl());
            ((UpSendMsgReq)localObject).setCollapseKey(paramRemoteMessage.getCollapseKey());
            ((UpSendMsgReq)localObject).setSendMode(paramRemoteMessage.getSendMode());
            ((UpSendMsgReq)localObject).setReceiptMode(paramRemoteMessage.getReceiptMode());
            if (CommFun.isEmui10Plus())
            {
              this$0.doWrite(new BaseVoidTask("push.sendMessage", JsonUtil.createJsonString((IMessageEntity)localObject), str));
              return;
            }
            showMsg((UpSendMsgReq)localObject, str);
            return;
          }
          HMSLog.toString("HmsMessaging", "Mandatory parameter 'data' missing");
          PushBiUtil.reportExit(sslContext, "push.sendMessage", str, ErrorEnum.ERROR_ARGUMENTS_INVALID);
          throw new IllegalArgumentException("Mandatory parameter 'data' missing");
        }
        HMSLog.toString("HmsMessaging", "Mandatory parameter 'message_id' missing");
        PushBiUtil.reportExit(sslContext, "push.sendMessage", str, ErrorEnum.ERROR_ARGUMENTS_INVALID);
        throw new IllegalArgumentException("Mandatory parameter 'message_id' missing");
      }
      HMSLog.toString("HmsMessaging", "Mandatory parameter 'to' missing");
      PushBiUtil.reportExit(sslContext, "push.sendMessage", str, ErrorEnum.ERROR_ARGUMENTS_INVALID);
      throw new IllegalArgumentException("Mandatory parameter 'to' missing");
    }
    paramRemoteMessage = new StringBuilder();
    paramRemoteMessage.append("Message sent failed:");
    paramRemoteMessage.append(((ErrorEnum)localObject).getExternalCode());
    paramRemoteMessage.append(':');
    paramRemoteMessage.append(((ErrorEnum)localObject).getMessage());
    HMSLog.toString("HmsMessaging", paramRemoteMessage.toString());
    PushBiUtil.reportExit(sslContext, "push.sendMessage", str, (ErrorEnum)localObject);
    throw new UnsupportedOperationException(((ErrorEnum)localObject).getMessage());
  }
  
  public void send(RemoteMessage paramRemoteMessage)
  {
    if (ProxyCenter.getProxy() == null)
    {
      HMSLog.append("HmsMessaging", "send upstream message");
      processResponse(paramRemoteMessage);
      return;
    }
    HMSLog.toString("HmsMessaging", "Operation(send) unsupported");
    throw new UnsupportedOperationException("Operation(send) unsupported");
  }
  
  public final Task setAlarm(boolean paramBoolean)
  {
    String str = PushBiUtil.reportEntry(sslContext, "push.setNotifyFlag");
    if ((CommFun.isFrameworkPushExist(sslContext)) && (!CommFun.isEmui10Plus()))
    {
      if (HwBuildEx.VERSION.EMUI_SDK_INT < 12)
      {
        HMSLog.toString("HmsMessaging", "operation not available on Huawei device with EMUI lower than 5.1");
        localObject1 = new TaskCompletionSource();
        ((TaskCompletionSource)localObject1).setException(ErrorEnum.ERROR_OPERATION_NOT_SUPPORTED.toApiException());
        PushBiUtil.reportExit(sslContext, "push.setNotifyFlag", str, ErrorEnum.ERROR_OPERATION_NOT_SUPPORTED);
        return ((TaskCompletionSource)localObject1).getTask();
      }
      if (CommFun.getNCVersionCode(sslContext) < 90101310L)
      {
        HMSLog.append("HmsMessaging", "turn on/off with broadcast v1");
        localObject1 = sslContext;
        localObject2 = new StringBuilder();
        ((StringBuilder)localObject2).append(sslContext.getPackageName());
        ((StringBuilder)localObject2).append("#");
        ((StringBuilder)localObject2).append(paramBoolean);
        localObject1 = PushEncrypter.encrypterOld((Context)localObject1, ((StringBuilder)localObject2).toString());
        localObject1 = new Intent("com.huawei.intent.action.SELF_SHOW_FLAG").putExtra("enalbeFlag", (String)localObject1);
        ((Intent)localObject1).setPackage("android");
        return Tasks.callInBackground(new IntentCallable(sslContext, (Intent)localObject1, str));
      }
      HMSLog.append("HmsMessaging", "turn on/off with broadcast v2");
      new PushPreferences(sslContext, "push_notify_flag").saveBoolean("notify_msg_enable", paramBoolean ^ true);
      localObject1 = new StringBuilder();
      ((StringBuilder)localObject1).append("content://");
      ((StringBuilder)localObject1).append(sslContext.getPackageName());
      ((StringBuilder)localObject1).append(".huawei.push.provider/");
      ((StringBuilder)localObject1).append("push_notify_flag");
      ((StringBuilder)localObject1).append(".xml");
      localObject1 = Uri.parse(((StringBuilder)localObject1).toString());
      Object localObject2 = new Intent("com.huawei.android.push.intent.SDK_COMMAND");
      ((Intent)localObject2).putExtra("type", "enalbeFlag");
      ((Intent)localObject2).putExtra("pkgName", sslContext.getPackageName());
      ((Intent)localObject2).putExtra("url", (Parcelable)localObject1);
      ((Intent)localObject2).setPackage("android");
      return Tasks.callInBackground(new IntentCallable(sslContext, (Intent)localObject2, str));
    }
    HMSLog.append("HmsMessaging", "turn on/off with AIDL");
    Object localObject1 = new EnableNotifyReq();
    ((EnableNotifyReq)localObject1).setPackageName(sslContext.getPackageName());
    ((EnableNotifyReq)localObject1).setEnable(paramBoolean);
    return this$0.doWrite(new BaseVoidTask("push.setNotifyFlag", JsonUtil.createJsonString((IMessageEntity)localObject1), str));
  }
  
  public void setAutoInitEnabled(boolean paramBoolean)
  {
    AutoInitHelper.setAutoInitEnabled(sslContext, paramBoolean);
  }
  
  public final void showMsg(UpSendMsgReq paramUpSendMsgReq, String paramString)
  {
    paramUpSendMsgReq.setToken(BaseUtils.getLocalToken(sslContext, null));
    HuaweiApi localHuaweiApi = this$0;
    try
    {
      localHuaweiApi.doWrite(new SendUpStreamTask("push.sendMessage", JsonUtil.createJsonString(paramUpSendMsgReq), paramString, paramUpSendMsgReq.getPackageName(), paramUpSendMsgReq.getMessageId()));
      return;
    }
    catch (Exception paramUpSendMsgReq)
    {
      if ((((Exception)paramUpSendMsgReq).getCause() instanceof ApiException))
      {
        paramUpSendMsgReq = (ApiException)((Exception)paramUpSendMsgReq).getCause();
        PushBiUtil.reportExit(sslContext, "push.sendMessage", paramString, paramUpSendMsgReq.getStatusCode());
        return;
      }
      PushBiUtil.reportExit(sslContext, "push.sendMessage", paramString, ErrorEnum.ERROR_INTERNAL_ERROR);
    }
  }
  
  public Task subscribe(String paramString)
  {
    HMSLog.append("HmsMessaging", "invoke subscribe");
    return processResponse(paramString, "Sub");
  }
  
  public Task turnOffPush()
  {
    if (ProxyCenter.getProxy() != null)
    {
      HMSLog.append("HmsMessaging", "turn off for proxy");
      return ProxyCenter.getProxy().turnOff(sslContext, null);
    }
    HMSLog.append("HmsMessaging", "invoke turnOffPush");
    return setAlarm(false);
  }
  
  public Task turnOnPush()
  {
    if (ProxyCenter.getProxy() != null)
    {
      HMSLog.append("HmsMessaging", "turn on for proxy");
      return ProxyCenter.getProxy().turnOn(sslContext, null);
    }
    HMSLog.append("HmsMessaging", "invoke turnOnPush");
    return setAlarm(true);
  }
  
  public Task unsubscribe(String paramString)
  {
    HMSLog.append("HmsMessaging", "invoke unsubscribe");
    return processResponse(paramString, "UnSub");
  }
}
