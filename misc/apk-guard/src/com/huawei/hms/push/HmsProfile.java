package com.huawei.hms.push;

import android.app.Activity;
import android.content.Context;
import android.text.TextUtils;
import com.huawei.agconnect.config.AGConnectServicesConfig;
import com.huawei.hms.aaid.constant.ErrorEnum;
import com.huawei.hms.aaid.task.PushClientBuilder;
import com.huawei.hms.api.Api.ApiOptions.NoOptions;
import com.huawei.hms.common.ApiException;
import com.huawei.hms.common.HuaweiApi;
import com.huawei.hms.common.internal.Preconditions;
import com.huawei.hms.configurations.TermSession;
import com.huawei.hms.core.aidl.IMessageEntity;
import com.huawei.hms.push.task.ProfileTask;
import com.huawei.hms.push.utils.PushBiUtil;
import com.huawei.hms.support.model.HMSLog;
import com.huawei.hms.support.mozilla.entity.push.ProfileReq;
import com.huawei.hms.support.mozilla.push.utils.CommFun;
import com.huawei.hms.utils.JsonUtil;
import com.huawei.provider.tasks.Task;
import com.huawei.provider.tasks.TaskCompletionSource;
import com.huawei.secure.android.common.encrypt.hash.c;

public class HmsProfile
{
  public static final int CUSTOM_PROFILE = 2;
  public static final int HUAWEI_PROFILE = 1;
  public static final String j = "HmsProfile";
  public Context c = null;
  public HuaweiApi<Api.ApiOptions.NoOptions> d;
  
  public HmsProfile(Context paramContext)
  {
    Preconditions.checkNotNull(paramContext);
    c = paramContext;
    TermSession localTermSession = new TermSession("HuaweiPush.API");
    if ((paramContext instanceof Activity)) {
      d = new HuaweiApi((Activity)paramContext, localTermSession, null, new PushClientBuilder());
    } else {
      d = new HuaweiApi(paramContext, localTermSession, null, new PushClientBuilder());
    }
    d.setKitSdkVersion(50004300);
  }
  
  public static String get(Context paramContext)
  {
    return AGConnectServicesConfig.fromContext(paramContext).getString("client/project_id");
  }
  
  public static HmsProfile getInstance(Context paramContext)
  {
    return new HmsProfile(paramContext);
  }
  
  public Task addProfile(int paramInt, String paramString)
  {
    return addProfile("", paramInt, paramString);
  }
  
  public Task addProfile(String paramString1, int paramInt, String paramString2)
  {
    if ((paramInt != 1) && (paramInt != 2))
    {
      HMSLog.append(j, "add profile type undefined.");
      paramString1 = new TaskCompletionSource();
      paramString1.setException(ErrorEnum.ERROR_PUSH_ARGUMENTS_INVALID.toApiException());
      return paramString1.getTask();
    }
    if (TextUtils.isEmpty(paramString2))
    {
      HMSLog.append(j, "add profile params is empty.");
      paramString1 = new TaskCompletionSource();
      paramString1.setException(ErrorEnum.ERROR_PUSH_ARGUMENTS_INVALID.toApiException());
      return paramString1.getTask();
    }
    return e(0, paramString1, paramInt, paramString2);
  }
  
  public final boolean createFolder(Context paramContext)
  {
    return CommFun.getNCVersionCode(paramContext) >= 110001400L;
  }
  
  public Task deleteProfile(String paramString)
  {
    return deleteProfile("", paramString);
  }
  
  public Task deleteProfile(String paramString1, String paramString2)
  {
    if (TextUtils.isEmpty(paramString2))
    {
      HMSLog.toString(j, "del profile params is empty.");
      paramString1 = new TaskCompletionSource();
      paramString1.setException(ErrorEnum.ERROR_PUSH_ARGUMENTS_INVALID.toApiException());
      return paramString1.getTask();
    }
    return e(1, paramString1, -1, paramString2);
  }
  
  public final Task e(int paramInt1, String paramString1, int paramInt2, String paramString2)
  {
    if (!isSupportProfile())
    {
      paramString1 = new TaskCompletionSource();
      paramString1.setException(ErrorEnum.ERROR_OPERATION_NOT_SUPPORTED.toApiException());
      return paramString1.getTask();
    }
    String str = paramString1;
    if (!TextUtils.isEmpty(paramString1))
    {
      localObject = get(c);
      if (TextUtils.isEmpty((CharSequence)localObject))
      {
        HMSLog.append(j, "agc connect services config missing project id.");
        paramString1 = new TaskCompletionSource();
        paramString1.setException(ErrorEnum.ERROR_MISSING_PROJECT_ID.toApiException());
        return paramString1.getTask();
      }
      str = paramString1;
      if (paramString1.equals(localObject)) {
        str = "";
      }
    }
    Object localObject = new ProfileReq();
    if (paramInt1 == 0)
    {
      ((ProfileReq)localObject).setOperation(0);
      ((ProfileReq)localObject).setType(paramInt2);
    }
    else
    {
      ((ProfileReq)localObject).setOperation(1);
    }
    paramString1 = PushBiUtil.reportEntry(c, "push.profile");
    try
    {
      ((ProfileReq)localObject).setSubjectId(str);
      ((ProfileReq)localObject).setProfileId(c.sha256Encrypt(paramString2));
      paramString2 = c;
      ((ProfileReq)localObject).setPkgName(paramString2.getPackageName());
      paramString2 = d;
      paramString2 = paramString2.doWrite(new ProfileTask("push.profile", JsonUtil.createJsonString((IMessageEntity)localObject), paramString1));
      return paramString2;
    }
    catch (Exception localException)
    {
      if ((((Exception)localException).getCause() instanceof ApiException))
      {
        paramString2 = new TaskCompletionSource();
        ApiException localApiException = (ApiException)((Exception)localException).getCause();
        paramString2.setException(localApiException);
        PushBiUtil.reportExit(c, "push.profile", paramString1, localApiException.getStatusCode());
        return paramString2.getTask();
      }
      paramString2 = new TaskCompletionSource();
      PushBiUtil.reportExit(c, "push.profile", paramString1, ErrorEnum.ERROR_INTERNAL_ERROR);
      paramString2.setException(ErrorEnum.ERROR_INTERNAL_ERROR.toApiException());
    }
    return paramString2.getTask();
  }
  
  public boolean isSupportProfile()
  {
    if (CommFun.isFrameworkPushExist(c))
    {
      if (CommFun.isEmui91Below())
      {
        HMSLog.append(j, "current EMUI version below 9.1, not support profile operation.");
        return false;
      }
      if (!createFolder(c))
      {
        HMSLog.append(j, "current HwPushService.apk version below 11.0.1.400,please upgrade your HwPushService.apk version.");
        return false;
      }
    }
    return true;
  }
}
