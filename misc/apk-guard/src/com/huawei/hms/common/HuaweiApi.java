package com.huawei.hms.common;

import android.app.Activity;
import android.content.Context;
import android.os.Looper;
import android.text.TextUtils;
import com.huawei.hms.common.internal.AbstractClientBuilder;
import com.huawei.hms.common.internal.AnyClient;
import com.huawei.hms.common.internal.ClientSettings;
import com.huawei.hms.common.internal.ConnectionManagerKey;
import com.huawei.hms.common.internal.HuaweiApiManager;
import com.huawei.hms.common.internal.HuaweiApiManager.ConnectionManager;
import com.huawei.hms.common.internal.TaskApiCall;
import com.huawei.hms.configurations.TermSession;
import com.huawei.hms.support.hianalytics.HiAnalyticsInnerClient;
import com.huawei.hms.support.model.HMSLog;
import com.huawei.hms.support.mozilla.client.Status;
import com.huawei.hms.support.mozilla.client.SubAppInfo;
import com.huawei.hms.utils.Checker;
import com.huawei.hms.utils.HMSBIInitializer;
import com.huawei.hms.utils.HMSPackageManager;
import com.huawei.hms.utils.Util;
import com.huawei.provider.tasks.Task;
import com.huawei.provider.tasks.TaskCompletionSource;
import java.lang.ref.WeakReference;
import java.util.Collections;
import java.util.List;

public class HuaweiApi<TOption extends com.huawei.hms.api.Api.ApiOptions>
{
  private static final String PAGE_KEY = "HuaweiApi";
  private int apiLevel = 1;
  private String innerHmsPkg;
  private boolean isFirstReqSent = false;
  private WeakReference<Activity> mActivity;
  private String mAppID;
  private AbstractClientBuilder<?, TOption> mClientBuilder;
  private ConnectionManagerKey<TOption> mConnectionManagerKey;
  private Context mContext;
  private String mCpID;
  private String mHostAppid;
  private HuaweiApiManager mHuaweiApiManager;
  private int mKitSdkVersion;
  private TOption mOption;
  private SubAppInfo mSubAppInfo;
  
  public HuaweiApi(Activity paramActivity, TermSession paramTermSession, com.huawei.hms.configurations.Api.ApiOptions paramApiOptions, AbstractClientBuilder paramAbstractClientBuilder)
  {
    Checker.checkNonNull(paramActivity, "Null activity is not permitted.");
    mActivity = new WeakReference(paramActivity);
    init(paramActivity, paramTermSession, paramApiOptions, paramAbstractClientBuilder, 0, null);
  }
  
  public HuaweiApi(Activity paramActivity, TermSession paramTermSession, com.huawei.hms.configurations.Api.ApiOptions paramApiOptions, AbstractClientBuilder paramAbstractClientBuilder, int paramInt)
  {
    Checker.checkNonNull(paramActivity, "Null activity is not permitted.");
    mActivity = new WeakReference(paramActivity);
    init(paramActivity, paramTermSession, paramApiOptions, paramAbstractClientBuilder, paramInt, null);
  }
  
  public HuaweiApi(Activity paramActivity, TermSession paramTermSession, com.huawei.hms.configurations.Api.ApiOptions paramApiOptions, AbstractClientBuilder paramAbstractClientBuilder, int paramInt, String paramString)
  {
    Checker.checkNonNull(paramActivity, "Null activity is not permitted.");
    mActivity = new WeakReference(paramActivity);
    init(paramActivity, paramTermSession, paramApiOptions, paramAbstractClientBuilder, paramInt, paramString);
  }
  
  public HuaweiApi(Context paramContext, TermSession paramTermSession, com.huawei.hms.configurations.Api.ApiOptions paramApiOptions, AbstractClientBuilder paramAbstractClientBuilder)
  {
    Checker.checkNonNull(paramContext, "Null context is not permitted.");
    init(paramContext, paramTermSession, paramApiOptions, paramAbstractClientBuilder, 0, null);
  }
  
  public HuaweiApi(Context paramContext, TermSession paramTermSession, com.huawei.hms.configurations.Api.ApiOptions paramApiOptions, AbstractClientBuilder paramAbstractClientBuilder, int paramInt)
  {
    Checker.checkNonNull(paramContext, "Null context is not permitted.");
    init(paramContext, paramTermSession, paramApiOptions, paramAbstractClientBuilder, paramInt, null);
  }
  
  public HuaweiApi(Context paramContext, TermSession paramTermSession, com.huawei.hms.configurations.Api.ApiOptions paramApiOptions, AbstractClientBuilder paramAbstractClientBuilder, int paramInt, String paramString)
  {
    Checker.checkNonNull(paramContext, "Null context is not permitted.");
    init(paramContext, paramTermSession, paramApiOptions, paramAbstractClientBuilder, paramInt, paramString);
  }
  
  private void init(Context paramContext, TermSession paramTermSession, com.huawei.hms.configurations.Api.ApiOptions paramApiOptions, AbstractClientBuilder paramAbstractClientBuilder, int paramInt, String paramString)
  {
    mContext = paramContext.getApplicationContext();
    mHuaweiApiManager = HuaweiApiManager.getInstance(mContext);
    mConnectionManagerKey = ConnectionManagerKey.createConnectionManagerKey(paramContext, paramTermSession, paramApiOptions, paramString);
    mOption = paramApiOptions;
    mClientBuilder = paramAbstractClientBuilder;
    mHostAppid = Util.getAppId(paramContext);
    mAppID = mHostAppid;
    mCpID = Util.getCpId(paramContext);
    mSubAppInfo = new SubAppInfo("");
    mKitSdkVersion = paramInt;
    if (!TextUtils.isEmpty(paramString)) {
      if (paramString.equals(mHostAppid))
      {
        HMSLog.toString("HuaweiApi", "subAppId is host appid");
      }
      else
      {
        paramTermSession = new StringBuilder();
        paramTermSession.append("subAppId is ");
        paramTermSession.append(paramString);
        HMSLog.append("HuaweiApi", paramTermSession.toString());
        mSubAppInfo = new SubAppInfo(paramString);
      }
    }
    initBI(paramContext);
  }
  
  private void initBI(Context paramContext)
  {
    HMSBIInitializer.getInstance(paramContext).initBI();
  }
  
  private Task sendRequest(TaskApiCall paramTaskApiCall)
  {
    TaskCompletionSource localTaskCompletionSource;
    if (paramTaskApiCall.getToken() == null) {
      localTaskCompletionSource = new TaskCompletionSource();
    } else {
      localTaskCompletionSource = new TaskCompletionSource(paramTaskApiCall.getToken());
    }
    mHuaweiApiManager.sendRequest(this, paramTaskApiCall, localTaskCompletionSource);
    return localTaskCompletionSource.getTask();
  }
  
  public Task disconnectService()
  {
    TaskCompletionSource localTaskCompletionSource = new TaskCompletionSource();
    mHuaweiApiManager.disconnectService(this, localTaskCompletionSource);
    return localTaskCompletionSource.getTask();
  }
  
  public Task doWrite(TaskApiCall paramTaskApiCall)
  {
    isFirstReqSent = true;
    if (paramTaskApiCall == null)
    {
      HMSLog.toString("HuaweiApi", "in doWrite:taskApiCall is null");
      paramTaskApiCall = new TaskCompletionSource();
      paramTaskApiCall.setException(new ApiException(Status.FAILURE));
      return paramTaskApiCall.getTask();
    }
    String str;
    if (TextUtils.isEmpty(mSubAppInfo.getSubAppID())) {
      str = mAppID;
    } else {
      str = mSubAppInfo.getSubAppID();
    }
    HiAnalyticsInnerClient.reportEntryClient(mContext, paramTaskApiCall.getUri(), str, paramTaskApiCall.getTransactionId(), String.valueOf(getKitSdkVersion()));
    return sendRequest(paramTaskApiCall);
  }
  
  public Activity getActivity()
  {
    WeakReference localWeakReference = mActivity;
    if (localWeakReference != null) {
      return (Activity)localWeakReference.get();
    }
    return null;
  }
  
  public int getApiLevel()
  {
    return apiLevel;
  }
  
  public String getAppID()
  {
    return mAppID;
  }
  
  public AnyClient getClient(Looper paramLooper, HuaweiApiManager.ConnectionManager paramConnectionManager)
  {
    return mClientBuilder.buildClient(mContext, getClientSetting(), paramConnectionManager, paramConnectionManager);
  }
  
  protected ClientSettings getClientSetting()
  {
    ClientSettings localClientSettings = new ClientSettings(mContext.getPackageName(), mContext.getClass().getName(), getScopes(), mHostAppid, null, mSubAppInfo);
    localClientSettings.setCpID(mCpID);
    if (TextUtils.isEmpty(innerHmsPkg))
    {
      innerHmsPkg = HMSPackageManager.getInstance(mContext).getHMSPackageName();
      localObject = new StringBuilder();
      ((StringBuilder)localObject).append("inner hms is empty,hms pkg name is ");
      ((StringBuilder)localObject).append(innerHmsPkg);
      HMSLog.append("HuaweiApi", ((StringBuilder)localObject).toString());
    }
    localClientSettings.setInnerHmsPkg(innerHmsPkg);
    Object localObject = mActivity;
    if (localObject != null) {
      localClientSettings.setCpActivity((Activity)((WeakReference)localObject).get());
    }
    return localClientSettings;
  }
  
  public ConnectionManagerKey getConnectionManagerKey()
  {
    return mConnectionManagerKey;
  }
  
  public Context getContext()
  {
    return mContext;
  }
  
  public int getKitSdkVersion()
  {
    return mKitSdkVersion;
  }
  
  public com.huawei.hms.configurations.Api.ApiOptions getOption()
  {
    return mOption;
  }
  
  protected List getScopes()
  {
    return Collections.emptyList();
  }
  
  public String getSubAppID()
  {
    return mSubAppInfo.getSubAppID();
  }
  
  public void setApiLevel(int paramInt)
  {
    apiLevel = paramInt;
  }
  
  public void setInnerHms()
  {
    innerHmsPkg = mContext.getPackageName();
    StringBuilder localStringBuilder = new StringBuilder();
    localStringBuilder.append("init inner hms pkg info:");
    localStringBuilder.append(innerHmsPkg);
    HMSLog.append("HuaweiApi", localStringBuilder.toString());
  }
  
  public void setKitSdkVersion(int paramInt)
  {
    mKitSdkVersion = paramInt;
  }
  
  public void setSubAppId(String paramString)
    throws ApiException
  {
    if (setSubAppInfo(new SubAppInfo(paramString))) {
      return;
    }
    throw new ApiException(Status.FAILURE);
  }
  
  public boolean setSubAppInfo(SubAppInfo paramSubAppInfo)
  {
    HMSLog.append("HuaweiApi", "Enter setSubAppInfo");
    Object localObject = mSubAppInfo;
    if ((localObject != null) && (!TextUtils.isEmpty(((SubAppInfo)localObject).getSubAppID())))
    {
      HMSLog.toString("HuaweiApi", "subAppInfo is already set");
      return false;
    }
    if (paramSubAppInfo == null)
    {
      HMSLog.toString("HuaweiApi", "subAppInfo is null");
      return false;
    }
    localObject = paramSubAppInfo.getSubAppID();
    if (TextUtils.isEmpty((CharSequence)localObject))
    {
      HMSLog.toString("HuaweiApi", "subAppId is empty");
      return false;
    }
    if (((String)localObject).equals(mHostAppid))
    {
      HMSLog.toString("HuaweiApi", "subAppId is host appid");
      return false;
    }
    if (isFirstReqSent)
    {
      HMSLog.toString("HuaweiApi", "Client has sent request to Huawei Mobile Services, setting subAppId is not allowed");
      return false;
    }
    mSubAppInfo = new SubAppInfo(paramSubAppInfo);
    return true;
  }
}
