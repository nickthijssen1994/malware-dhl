package com.huawei.secure.android.common.encrypt.keystore.runtime;

import android.os.Build.VERSION;
import android.security.keystore.KeyGenParameterSpec.Builder;
import android.text.TextUtils;
import android.util.Base64;
import android.util.Log;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.security.InvalidAlgorithmParameterException;
import java.security.InvalidKeyException;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.KeyStore;
import java.security.KeyStore.Entry;
import java.security.KeyStore.PrivateKeyEntry;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.Signature;
import java.security.SignatureException;
import java.security.UnrecoverableEntryException;
import java.security.UnrecoverableKeyException;
import java.security.cert.CertificateException;

public abstract class RSASignKS
{
  private static final String ACTION_UPDATE_ALL = "SHA256withRSA/PSS";
  private static final int DEFAULT_BUFFER_SIZE = 3072;
  private static final int MAX_CHUNK_SIZE = 2048;
  private static final String NULL_LABEL = "";
  private static final String PAGE_KEY = "AndroidKeyStore";
  private static final String digest = "RSASignKS";
  
  public RSASignKS() {}
  
  private static KeyStore.Entry get(String paramString, boolean paramBoolean)
  {
    if (!init(paramString)) {
      init(paramString, paramBoolean);
    }
    try
    {
      localObject = KeyStore.getInstance("AndroidKeyStore");
      ((KeyStore)localObject).load(null);
      paramString = ((KeyStore)localObject).getEntry(paramString, null);
      return paramString;
    }
    catch (UnrecoverableEntryException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("UnrecoverableEntryException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return null;
    }
    catch (IOException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("IOException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return null;
    }
    catch (NoSuchAlgorithmException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("NoSuchAlgorithmException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return null;
    }
    catch (CertificateException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("CertificateException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return null;
    }
    catch (KeyStoreException paramString)
    {
      Object localObject = digest;
      StringBuilder localStringBuilder = new StringBuilder();
      localStringBuilder.append("KeyStoreException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
    }
    return null;
  }
  
  private static KeyPair init(String paramString, boolean paramBoolean)
  {
    try
    {
      boolean bool = init(paramString);
      Object localObject1 = null;
      if (bool)
      {
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(digest, "Key pair exits");
        return null;
      }
      try
      {
        localObject2 = KeyPairGenerator.getInstance("RSA", "AndroidKeyStore");
        if (!paramBoolean)
        {
          paramString = new KeyGenParameterSpec.Builder(paramString, 12);
          paramString = paramString.setDigests(new String[] { "SHA-256", "SHA-512" });
          ((KeyPairGenerator)localObject2).initialize(paramString.setSignaturePaddings(new String[] { "PSS" }).setKeySize(2048).build());
        }
        else
        {
          paramString = new KeyGenParameterSpec.Builder(paramString, 12);
          paramString = paramString.setDigests(new String[] { "SHA-256", "SHA-512" });
          ((KeyPairGenerator)localObject2).initialize(paramString.setSignaturePaddings(new String[] { "PSS" }).setKeySize(3072).build());
        }
        paramString = ((KeyPairGenerator)localObject2).generateKeyPair();
      }
      catch (InvalidAlgorithmParameterException paramString)
      {
        localObject2 = digest;
        localStringBuilder = new StringBuilder();
        localStringBuilder.append("InvalidAlgorithmParameterException: ");
        localStringBuilder.append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject2, localStringBuilder.toString());
        paramString = localObject1;
      }
      catch (NoSuchProviderException paramString)
      {
        localObject2 = digest;
        localStringBuilder = new StringBuilder();
        localStringBuilder.append("NoSuchProviderException: ");
        localStringBuilder.append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject2, localStringBuilder.toString());
        paramString = localObject1;
      }
      catch (NoSuchAlgorithmException paramString)
      {
        Object localObject2 = digest;
        StringBuilder localStringBuilder = new StringBuilder();
        localStringBuilder.append("NoSuchAlgorithmException: ");
        localStringBuilder.append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject2, localStringBuilder.toString());
        paramString = localObject1;
      }
      return paramString;
    }
    catch (Throwable paramString)
    {
      throw paramString;
    }
  }
  
  private static boolean init(String paramString)
  {
    try
    {
      localObject = KeyStore.getInstance("AndroidKeyStore");
      ((KeyStore)localObject).load(null);
      paramString = ((KeyStore)localObject).getKey(paramString, null);
      if (paramString != null) {
        return true;
      }
    }
    catch (IOException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("IOException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return false;
    }
    catch (NoSuchAlgorithmException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("NoSuchAlgorithmException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return false;
    }
    catch (UnrecoverableKeyException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("UnrecoverableKeyException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return false;
    }
    catch (CertificateException paramString)
    {
      localObject = digest;
      localStringBuilder = new StringBuilder();
      localStringBuilder.append("CertificateException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
      return false;
    }
    catch (KeyStoreException paramString)
    {
      Object localObject = digest;
      StringBuilder localStringBuilder = new StringBuilder();
      localStringBuilder.append("KeyStoreException: ");
      localStringBuilder.append(paramString.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append((String)localObject, localStringBuilder.toString());
    }
    return false;
  }
  
  private static byte[] init(String paramString, byte[] paramArrayOfByte, boolean paramBoolean)
  {
    byte[] arrayOfByte = new byte[0];
    if ((!TextUtils.isEmpty(paramString)) && (paramArrayOfByte != null))
    {
      if (!isBuildVersionHigherThan22())
      {
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(digest, "sdk version is too low");
        return arrayOfByte;
      }
      Object localObject = get(paramString, paramBoolean);
      if (!(localObject instanceof KeyStore.PrivateKeyEntry))
      {
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(digest, "Not an instance of a PrivateKeyEntry");
        return arrayOfByte;
      }
      try
      {
        paramString = Signature.getInstance("SHA256withRSA/PSS");
        localObject = (KeyStore.PrivateKeyEntry)localObject;
        paramString.initSign(((KeyStore.PrivateKeyEntry)localObject).getPrivateKey());
        paramString.update(paramArrayOfByte);
        paramString = paramString.sign();
        return paramString;
      }
      catch (Exception paramString)
      {
        paramArrayOfByte = digest;
        localObject = new StringBuilder();
        ((StringBuilder)localObject).append("Exception: ");
        ((StringBuilder)localObject).append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte, ((StringBuilder)localObject).toString());
        return arrayOfByte;
      }
      catch (InvalidKeyException paramString)
      {
        paramArrayOfByte = digest;
        localObject = new StringBuilder();
        ((StringBuilder)localObject).append("InvalidKeyException: ");
        ((StringBuilder)localObject).append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte, ((StringBuilder)localObject).toString());
        return arrayOfByte;
      }
      catch (SignatureException paramString)
      {
        paramArrayOfByte = digest;
        localObject = new StringBuilder();
        ((StringBuilder)localObject).append("SignatureException: ");
        ((StringBuilder)localObject).append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte, ((StringBuilder)localObject).toString());
        return arrayOfByte;
      }
      catch (NoSuchAlgorithmException paramString)
      {
        paramArrayOfByte = digest;
        localObject = new StringBuilder();
        ((StringBuilder)localObject).append("NoSuchAlgorithmException: ");
        ((StringBuilder)localObject).append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte, ((StringBuilder)localObject).toString());
        return arrayOfByte;
      }
    }
    com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(digest, "alias or content is null");
    return arrayOfByte;
  }
  
  public static boolean isBuildVersionHigherThan22()
  {
    return Build.VERSION.SDK_INT >= 23;
  }
  
  public static String sign(String paramString1, String paramString2)
  {
    try
    {
      paramString1 = Base64.encodeToString(sign(paramString1, paramString2.getBytes("UTF-8")), 0);
      return paramString1;
    }
    catch (UnsupportedEncodingException paramString1)
    {
      paramString2 = digest;
      StringBuilder localStringBuilder = new StringBuilder();
      localStringBuilder.append("sign UnsupportedEncodingException : ");
      localStringBuilder.append(paramString1.getMessage());
      Log.e(paramString2, localStringBuilder.toString());
    }
    return "";
  }
  
  public static byte[] sign(String paramString, byte[] paramArrayOfByte)
  {
    return init(paramString, paramArrayOfByte, false);
  }
  
  public static String signNew(String paramString1, String paramString2)
  {
    try
    {
      paramString1 = Base64.encodeToString(signNew(paramString1, paramString2.getBytes("UTF-8")), 0);
      return paramString1;
    }
    catch (UnsupportedEncodingException paramString1)
    {
      paramString2 = digest;
      StringBuilder localStringBuilder = new StringBuilder();
      localStringBuilder.append("sign UnsupportedEncodingException : ");
      localStringBuilder.append(paramString1.getMessage());
      Log.e(paramString2, localStringBuilder.toString());
    }
    return "";
  }
  
  public static byte[] signNew(String paramString, byte[] paramArrayOfByte)
  {
    return init(paramString, paramArrayOfByte, true);
  }
  
  private static boolean verify(String paramString, byte[] paramArrayOfByte1, byte[] paramArrayOfByte2, boolean paramBoolean)
  {
    if ((!TextUtils.isEmpty(paramString)) && (paramArrayOfByte1 != null) && (paramArrayOfByte2 != null))
    {
      if (!isBuildVersionHigherThan22())
      {
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(digest, "sdk version is too low");
        return false;
      }
      Object localObject = get(paramString, paramBoolean);
      if (!(localObject instanceof KeyStore.PrivateKeyEntry))
      {
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(digest, "Not an instance of a PrivateKeyEntry");
        return false;
      }
      try
      {
        paramString = Signature.getInstance("SHA256withRSA/PSS");
        localObject = (KeyStore.PrivateKeyEntry)localObject;
        paramString.initVerify(((KeyStore.PrivateKeyEntry)localObject).getCertificate());
        paramString.update(paramArrayOfByte1);
        paramBoolean = paramString.verify(paramArrayOfByte2);
        return paramBoolean;
      }
      catch (Exception paramString)
      {
        paramArrayOfByte1 = digest;
        paramArrayOfByte2 = new StringBuilder();
        paramArrayOfByte2.append("Exception: ");
        paramArrayOfByte2.append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte1, paramArrayOfByte2.toString());
        return false;
      }
      catch (InvalidKeyException paramString)
      {
        paramArrayOfByte1 = digest;
        paramArrayOfByte2 = new StringBuilder();
        paramArrayOfByte2.append("InvalidKeyException: ");
        paramArrayOfByte2.append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte1, paramArrayOfByte2.toString());
        return false;
      }
      catch (SignatureException paramString)
      {
        paramArrayOfByte1 = digest;
        paramArrayOfByte2 = new StringBuilder();
        paramArrayOfByte2.append("SignatureException: ");
        paramArrayOfByte2.append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte1, paramArrayOfByte2.toString());
        return false;
      }
      catch (NoSuchAlgorithmException paramString)
      {
        paramArrayOfByte1 = digest;
        paramArrayOfByte2 = new StringBuilder();
        paramArrayOfByte2.append("NoSuchAlgorithmException: ");
        paramArrayOfByte2.append(paramString.getMessage());
        com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramArrayOfByte1, paramArrayOfByte2.toString());
        return false;
      }
    }
    com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(digest, "alias or content or sign value is null");
    return false;
  }
  
  public static boolean verifySign(String paramString1, String paramString2, String paramString3)
  {
    try
    {
      boolean bool = verifySign(paramString1, paramString2.getBytes("UTF-8"), Base64.decode(paramString3, 0));
      return bool;
    }
    catch (Exception paramString1)
    {
      paramString2 = digest;
      paramString3 = new StringBuilder();
      paramString3.append("base64 decode Exception");
      paramString3.append(paramString1.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramString2, paramString3.toString());
      return false;
    }
    catch (UnsupportedEncodingException paramString1)
    {
      paramString2 = digest;
      paramString3 = new StringBuilder();
      paramString3.append("verifySign UnsupportedEncodingException: ");
      paramString3.append(paramString1.getMessage());
      Log.e(paramString2, paramString3.toString());
    }
    return false;
  }
  
  public static boolean verifySign(String paramString, byte[] paramArrayOfByte1, byte[] paramArrayOfByte2)
  {
    return verify(paramString, paramArrayOfByte1, paramArrayOfByte2, false);
  }
  
  public static boolean verifySignNew(String paramString1, String paramString2, String paramString3)
  {
    try
    {
      boolean bool = verifySignNew(paramString1, paramString2.getBytes("UTF-8"), Base64.decode(paramString3, 0));
      return bool;
    }
    catch (Exception paramString1)
    {
      paramString2 = digest;
      paramString3 = new StringBuilder();
      paramString3.append("base64 decode Exception");
      paramString3.append(paramString1.getMessage());
      com.huawei.secure.android.common.encrypt.utils.StringBuilder.append(paramString2, paramString3.toString());
      return false;
    }
    catch (UnsupportedEncodingException paramString1)
    {
      paramString2 = digest;
      paramString3 = new StringBuilder();
      paramString3.append("verifySign UnsupportedEncodingException: ");
      paramString3.append(paramString1.getMessage());
      Log.e(paramString2, paramString3.toString());
    }
    return false;
  }
  
  public static boolean verifySignNew(String paramString, byte[] paramArrayOfByte1, byte[] paramArrayOfByte2)
  {
    return verify(paramString, paramArrayOfByte1, paramArrayOfByte2, true);
  }
}
