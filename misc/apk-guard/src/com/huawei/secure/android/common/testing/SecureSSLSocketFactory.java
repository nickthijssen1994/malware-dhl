package com.huawei.secure.android.common.testing;

import android.content.Context;
import com.huawei.secure.android.common.testing.util.Log;
import com.huawei.secure.android.common.testing.util.Prefs;
import java.io.IOException;
import java.io.InputStream;
import java.net.InetAddress;
import java.net.Socket;
import java.net.UnknownHostException;
import java.security.KeyManagementException;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.cert.CertificateException;
import java.security.cert.X509Certificate;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSocket;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import org.apache.http.conn.ssl.BrowserCompatHostnameVerifier;
import org.apache.http.conn.ssl.StrictHostnameVerifier;
import org.apache.http.conn.ssl.X509HostnameVerifier;

public class SecureSSLSocketFactory
  extends javax.net.ssl.SSLSocketFactory
{
  @Deprecated
  public static final X509HostnameVerifier BROWSER_COMPATIBLE_HOSTNAME_VERIFIER = new BrowserCompatHostnameVerifier();
  @Deprecated
  public static final X509HostnameVerifier STRICT_HOSTNAME_VERIFIER = new StrictHostnameVerifier();
  private static final String TAG = com.huawei.secure.android.common.ssl.SecureSSLSocketFactory.class.getSimpleName();
  private static volatile SecureSSLSocketFactory instance = null;
  private String[] cipherSuites;
  private Context context;
  private String[] mClientId;
  private String[] protocols;
  private String[] server;
  private SSLSocket socket = null;
  private SSLContext sslContext = null;
  private X509TrustManager trustManager;
  
  private SecureSSLSocketFactory(Context paramContext)
    throws NoSuchAlgorithmException, CertificateException, KeyStoreException, IOException, KeyManagementException
  {
    if (paramContext == null)
    {
      Log.e(TAG, "SecureSSLSocketFactory: context is null");
      return;
    }
    setContext(paramContext);
    setSslContext(SSLUtil.setSSLContext());
    trustManager = SecureX509SingleInstance.getInstance(paramContext);
    sslContext.init(null, new X509TrustManager[] { trustManager }, null);
  }
  
  public SecureSSLSocketFactory(InputStream paramInputStream, String paramString)
    throws IOException, NoSuchAlgorithmException, CertificateException, KeyStoreException, KeyManagementException, IllegalArgumentException
  {
    sslContext = SSLUtil.setSSLContext();
    paramInputStream = new HiCloudX509TrustManager(paramInputStream, paramString);
    setX509TrustManager(paramInputStream);
    sslContext.init(null, (TrustManager[])new X509TrustManager[] { paramInputStream }, null);
  }
  
  public SecureSSLSocketFactory(X509TrustManager paramX509TrustManager)
    throws NoSuchAlgorithmException, KeyManagementException, IllegalArgumentException
  {
    sslContext = SSLUtil.setSSLContext();
    setX509TrustManager(paramX509TrustManager);
    sslContext.init(null, new X509TrustManager[] { paramX509TrustManager }, null);
  }
  
  static void cleanDB(X509TrustManager paramX509TrustManager)
  {
    Log.append(TAG, "ssf update socket factory trust manager");
    try
    {
      paramX509TrustManager = new SecureSSLSocketFactory(paramX509TrustManager);
      instance = paramX509TrustManager;
      return;
    }
    catch (NoSuchAlgorithmException paramX509TrustManager)
    {
      for (;;) {}
    }
    catch (KeyManagementException paramX509TrustManager)
    {
      for (;;) {}
    }
    Log.e(TAG, "KeyManagementException");
    return;
    Log.e(TAG, "NoSuchAlgorithmException");
  }
  
  private void createLayeredSocket(Socket paramSocket)
  {
    boolean bool = com.huawei.secure.android.common.testing.util.SSLSocketFactory.isEmpty(protocols);
    int j = 1;
    int i;
    if (!bool)
    {
      Log.append(TAG, "set protocols");
      SSLUtil.setEnabledProtocols((SSLSocket)paramSocket, protocols);
      i = 1;
    }
    else
    {
      i = 0;
    }
    if ((com.huawei.secure.android.common.testing.util.SSLSocketFactory.isEmpty(server)) && (com.huawei.secure.android.common.testing.util.SSLSocketFactory.isEmpty(mClientId)))
    {
      j = 0;
    }
    else
    {
      Log.append(TAG, "set white cipher or black cipher");
      SSLSocket localSSLSocket = (SSLSocket)paramSocket;
      SSLUtil.setEnabledProtocols(localSSLSocket);
      if (!com.huawei.secure.android.common.testing.util.SSLSocketFactory.isEmpty(server)) {
        SSLUtil.setWhiteListCipherSuites(localSSLSocket, server);
      } else {
        SSLUtil.setBlackListCipherSuites(localSSLSocket, mClientId);
      }
    }
    if (i == 0)
    {
      Log.append(TAG, "set default protocols");
      SSLUtil.setEnabledProtocols((SSLSocket)paramSocket);
    }
    if (j == 0)
    {
      Log.append(TAG, "set default cipher suites");
      SSLUtil.setEnableSafeCipherSuites((SSLSocket)paramSocket);
    }
  }
  
  public static SecureSSLSocketFactory getInstance(Context paramContext)
    throws IOException, NoSuchAlgorithmException, CertificateException, KeyStoreException, IllegalAccessException, KeyManagementException, IllegalArgumentException
  {
    Prefs.setContext(paramContext);
    if (instance == null) {
      try
      {
        if (instance == null) {
          instance = new SecureSSLSocketFactory(paramContext);
        }
      }
      catch (Throwable paramContext)
      {
        throw paramContext;
      }
    }
    if ((instancecontext == null) && (paramContext != null)) {
      instance.setContext(paramContext);
    }
    return instance;
  }
  
  public Socket createSocket(String paramString, int paramInt)
    throws IOException
  {
    Log.append(TAG, "createSocket: host , port");
    paramString = sslContext.getSocketFactory().createSocket(paramString, paramInt);
    if ((paramString instanceof SSLSocket))
    {
      createLayeredSocket(paramString);
      socket = ((SSLSocket)paramString);
      cipherSuites = ((String[])socket.getEnabledCipherSuites().clone());
    }
    return paramString;
  }
  
  public Socket createSocket(String paramString, int paramInt1, InetAddress paramInetAddress, int paramInt2)
    throws IOException, UnknownHostException
  {
    return createSocket(paramString, paramInt1);
  }
  
  public Socket createSocket(InetAddress paramInetAddress, int paramInt)
    throws IOException
  {
    return createSocket(paramInetAddress.getHostAddress(), paramInt);
  }
  
  public Socket createSocket(InetAddress paramInetAddress1, int paramInt1, InetAddress paramInetAddress2, int paramInt2)
    throws IOException
  {
    return createSocket(paramInetAddress1.getHostAddress(), paramInt1);
  }
  
  public Socket createSocket(Socket paramSocket, String paramString, int paramInt, boolean paramBoolean)
    throws IOException
  {
    Log.append(TAG, "createSocket s host port autoClose");
    paramSocket = sslContext.getSocketFactory().createSocket(paramSocket, paramString, paramInt, paramBoolean);
    if ((paramSocket instanceof SSLSocket))
    {
      createLayeredSocket(paramSocket);
      socket = ((SSLSocket)paramSocket);
      cipherSuites = ((String[])socket.getEnabledCipherSuites().clone());
    }
    return paramSocket;
  }
  
  public String[] getBlackCiphers()
  {
    return mClientId;
  }
  
  public X509Certificate[] getChain()
  {
    X509TrustManager localX509TrustManager = trustManager;
    if ((localX509TrustManager instanceof SecureX509TrustManager)) {
      return ((SecureX509TrustManager)localX509TrustManager).getChain();
    }
    return new X509Certificate[0];
  }
  
  public Context getContext()
  {
    return context;
  }
  
  public String[] getDefaultCipherSuites()
  {
    return new String[0];
  }
  
  public String[] getProtocols()
  {
    return protocols;
  }
  
  public SSLContext getSslContext()
  {
    return sslContext;
  }
  
  public SSLSocket getSslSocket()
  {
    return socket;
  }
  
  public String[] getSupportedCipherSuites()
  {
    String[] arrayOfString = cipherSuites;
    if (arrayOfString != null) {
      return arrayOfString;
    }
    return new String[0];
  }
  
  public String[] getWhiteCiphers()
  {
    return server;
  }
  
  public X509TrustManager getX509TrustManager()
  {
    return trustManager;
  }
  
  public void setBlackCiphers(String[] paramArrayOfString)
  {
    mClientId = paramArrayOfString;
  }
  
  public void setContext(Context paramContext)
  {
    context = paramContext.getApplicationContext();
  }
  
  public void setProtocols(String[] paramArrayOfString)
  {
    protocols = paramArrayOfString;
  }
  
  public void setSslContext(SSLContext paramSSLContext)
  {
    sslContext = paramSSLContext;
  }
  
  public void setWhiteCiphers(String[] paramArrayOfString)
  {
    server = paramArrayOfString;
  }
  
  public void setX509TrustManager(X509TrustManager paramX509TrustManager)
  {
    trustManager = paramX509TrustManager;
  }
}
