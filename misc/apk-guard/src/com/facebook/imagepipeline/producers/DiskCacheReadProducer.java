package com.facebook.imagepipeline.producers;

import bolts.f;
import bolts.g;
import com.facebook.cache.common.CacheKey;
import com.facebook.common.internal.ImmutableMap;
import com.facebook.imagepipeline.cache.BufferedDiskCache;
import com.facebook.imagepipeline.cache.CacheKeyFactory;
import com.facebook.imagepipeline.image.EncodedImage;
import com.facebook.imagepipeline.request.ImageRequest;
import com.facebook.imagepipeline.request.ImageRequest.CacheChoice;
import com.facebook.imagepipeline.request.ImageRequest.RequestLevel;
import java.util.Map;
import java.util.concurrent.CancellationException;
import java.util.concurrent.atomic.AtomicBoolean;

public class DiskCacheReadProducer
  implements Producer<EncodedImage>
{
  public static final String ENCODED_IMAGE_SIZE = "encodedImageSize";
  public static final String EXTRA_CACHED_VALUE_FOUND = "cached_value_found";
  public static final String PRODUCER_NAME = "DiskCacheProducer";
  private final CacheKeyFactory mCacheKeyFactory;
  private final BufferedDiskCache mDefaultBufferedDiskCache;
  private final Producer<EncodedImage> mInputProducer;
  private final BufferedDiskCache mSmallImageBufferedDiskCache;
  
  public DiskCacheReadProducer(BufferedDiskCache paramBufferedDiskCache1, BufferedDiskCache paramBufferedDiskCache2, CacheKeyFactory paramCacheKeyFactory, Producer paramProducer)
  {
    mDefaultBufferedDiskCache = paramBufferedDiskCache1;
    mSmallImageBufferedDiskCache = paramBufferedDiskCache2;
    mCacheKeyFactory = paramCacheKeyFactory;
    mInputProducer = paramProducer;
  }
  
  static Map getExtraMap(ProducerListener2 paramProducerListener2, ProducerContext paramProducerContext, boolean paramBoolean, int paramInt)
  {
    if (!paramProducerListener2.requiresExtraMap(paramProducerContext, "DiskCacheProducer")) {
      return null;
    }
    if (paramBoolean) {
      return ImmutableMap.of("cached_value_found", String.valueOf(paramBoolean), "encodedImageSize", String.valueOf(paramInt));
    }
    return ImmutableMap.of("cached_value_found", String.valueOf(paramBoolean));
  }
  
  private static boolean isTaskCancelled(g paramG)
  {
    return (paramG.c()) || ((paramG.d()) && ((paramG.f() instanceof CancellationException)));
  }
  
  private void maybeStartInputProducer(Consumer paramConsumer, ProducerContext paramProducerContext)
  {
    if (paramProducerContext.getLowestPermittedRequestLevel().getValue() >= ImageRequest.RequestLevel.DISK_CACHE.getValue())
    {
      paramConsumer.onNewResult(null, 1);
      return;
    }
    mInputProducer.produceResults(paramConsumer, paramProducerContext);
  }
  
  private f onFinishDiskReads(final Consumer paramConsumer, final ProducerContext paramProducerContext)
  {
    new f()
    {
      public Void then(g paramAnonymousG)
      {
        if (DiskCacheReadProducer.isTaskCancelled(paramAnonymousG))
        {
          val$listener.onProducerFinishWithCancellation(paramProducerContext, "DiskCacheProducer", null);
          paramConsumer.onCancellation();
          return null;
        }
        if (paramAnonymousG.d()) {
          val$listener.onProducerFinishWithFailure(paramProducerContext, "DiskCacheProducer", paramAnonymousG.f(), null);
        }
        for (;;)
        {
          mInputProducer.produceResults(paramConsumer, paramProducerContext);
          return null;
          paramAnonymousG = (EncodedImage)paramAnonymousG.e();
          if (paramAnonymousG != null)
          {
            localObject = val$listener;
            ProducerContext localProducerContext = paramProducerContext;
            ((ProducerListener2)localObject).onProducerFinishWithSuccess(localProducerContext, "DiskCacheProducer", DiskCacheReadProducer.getExtraMap((ProducerListener2)localObject, localProducerContext, true, paramAnonymousG.getSize()));
            val$listener.onUltimateProducerReached(paramProducerContext, "DiskCacheProducer", true);
            paramProducerContext.setExtra(1, "disk");
            paramConsumer.onProgressUpdate(1.0F);
            paramConsumer.onNewResult(paramAnonymousG, 1);
            paramAnonymousG.close();
            return null;
          }
          paramAnonymousG = val$listener;
          Object localObject = paramProducerContext;
          paramAnonymousG.onProducerFinishWithSuccess((ProducerContext)localObject, "DiskCacheProducer", DiskCacheReadProducer.getExtraMap(paramAnonymousG, (ProducerContext)localObject, false, 0));
        }
      }
    };
  }
  
  private void subscribeTaskForRequestCancellation(final AtomicBoolean paramAtomicBoolean, ProducerContext paramProducerContext)
  {
    paramProducerContext.addCallbacks(new BaseProducerContextCallbacks()
    {
      public void onCancellationRequested()
      {
        paramAtomicBoolean.set(true);
      }
    });
  }
  
  public void produceResults(Consumer paramConsumer, ProducerContext paramProducerContext)
  {
    Object localObject = paramProducerContext.getImageRequest();
    if (!((ImageRequest)localObject).isDiskCacheEnabled())
    {
      maybeStartInputProducer(paramConsumer, paramProducerContext);
      return;
    }
    paramProducerContext.getProducerListener().onProducerStart(paramProducerContext, "DiskCacheProducer");
    CacheKey localCacheKey = mCacheKeyFactory.getEncodedCacheKey((ImageRequest)localObject, paramProducerContext.getCallerContext());
    int i;
    if (((ImageRequest)localObject).getCacheChoice() == ImageRequest.CacheChoice.SMALL) {
      i = 1;
    } else {
      i = 0;
    }
    if (i != 0) {
      localObject = mSmallImageBufferedDiskCache;
    } else {
      localObject = mDefaultBufferedDiskCache;
    }
    AtomicBoolean localAtomicBoolean = new AtomicBoolean(false);
    ((BufferedDiskCache)localObject).getSeasons(localCacheKey, localAtomicBoolean).a(onFinishDiskReads(paramConsumer, paramProducerContext));
    subscribeTaskForRequestCancellation(localAtomicBoolean, paramProducerContext);
  }
}
