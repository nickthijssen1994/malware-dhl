package com.facebook.drawee.backends.pipeline.info;

import android.graphics.Rect;
import android.graphics.drawable.Drawable;
import com.facebook.common.time.MonotonicClock;
import com.facebook.drawee.backends.pipeline.PipelineDraweeController;
import com.facebook.drawee.backends.pipeline.info.internal.ImagePerfControllerListener;
import com.facebook.drawee.backends.pipeline.info.internal.ImagePerfImageOriginListener;
import com.facebook.drawee.backends.pipeline.info.internal.ImagePerfRequestListener;
import com.facebook.drawee.controller.AbstractDraweeController;
import com.facebook.drawee.controller.AbstractDraweeControllerBuilder;
import com.facebook.drawee.controller.ControllerListener;
import com.facebook.drawee.interfaces.DraweeHierarchy;
import com.facebook.imagepipeline.listener.ForwardingRequestListener;
import com.facebook.imagepipeline.listener.RequestListener;
import com.facebook.imagepipeline.request.ImageRequest;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import javax.annotation.Nullable;

public class ImagePerfMonitor
{
  private boolean mEnabled;
  @Nullable
  private ForwardingRequestListener mForwardingRequestListener;
  @Nullable
  private ImageOriginListener mImageOriginListener;
  @Nullable
  private ImageOriginRequestListener mImageOriginRequestListener;
  @Nullable
  private ImagePerfControllerListener mImagePerfControllerListener;
  @Nullable
  private List<ImagePerfDataListener> mImagePerfDataListeners;
  @Nullable
  private ImagePerfRequestListener mImagePerfRequestListener;
  private final ImagePerfState mImagePerfState;
  private final MonotonicClock mMonotonicClock;
  private final PipelineDraweeController mPipelineDraweeController;
  
  public ImagePerfMonitor(MonotonicClock paramMonotonicClock, PipelineDraweeController paramPipelineDraweeController)
  {
    mMonotonicClock = paramMonotonicClock;
    mPipelineDraweeController = paramPipelineDraweeController;
    mImagePerfState = new ImagePerfState();
  }
  
  private void setupListeners()
  {
    if (mImagePerfControllerListener == null) {
      mImagePerfControllerListener = new ImagePerfControllerListener(mMonotonicClock, mImagePerfState, this);
    }
    if (mImagePerfRequestListener == null) {
      mImagePerfRequestListener = new ImagePerfRequestListener(mMonotonicClock, mImagePerfState);
    }
    if (mImageOriginListener == null) {
      mImageOriginListener = new ImagePerfImageOriginListener(mImagePerfState, this);
    }
    ImageOriginRequestListener localImageOriginRequestListener = mImageOriginRequestListener;
    if (localImageOriginRequestListener == null) {
      mImageOriginRequestListener = new ImageOriginRequestListener(mPipelineDraweeController.getId(), mImageOriginListener);
    } else {
      localImageOriginRequestListener.init(mPipelineDraweeController.getId());
    }
    if (mForwardingRequestListener == null) {
      mForwardingRequestListener = new ForwardingRequestListener(new RequestListener[] { mImagePerfRequestListener, mImageOriginRequestListener });
    }
  }
  
  public void addImagePerfDataListener(ImagePerfDataListener paramImagePerfDataListener)
  {
    if (paramImagePerfDataListener == null) {
      return;
    }
    if (mImagePerfDataListeners == null) {
      mImagePerfDataListeners = new LinkedList();
    }
    mImagePerfDataListeners.add(paramImagePerfDataListener);
  }
  
  public void addViewportData()
  {
    Object localObject = mPipelineDraweeController.getHierarchy();
    if ((localObject != null) && (((DraweeHierarchy)localObject).getTopLevelDrawable() != null))
    {
      localObject = ((DraweeHierarchy)localObject).getTopLevelDrawable().getBounds();
      mImagePerfState.setOnScreenWidth(((Rect)localObject).width());
      mImagePerfState.setOnScreenHeight(((Rect)localObject).height());
    }
  }
  
  public void clearImagePerfDataListeners()
  {
    List localList = mImagePerfDataListeners;
    if (localList != null) {
      localList.clear();
    }
  }
  
  public void notifyListenersOfVisibilityStateUpdate(ImagePerfState paramImagePerfState, int paramInt)
  {
    if (mEnabled)
    {
      Object localObject = mImagePerfDataListeners;
      if (localObject != null)
      {
        if (((List)localObject).isEmpty()) {
          return;
        }
        paramImagePerfState = paramImagePerfState.snapshot();
        localObject = mImagePerfDataListeners.iterator();
        while (((Iterator)localObject).hasNext()) {
          ((ImagePerfDataListener)((Iterator)localObject).next()).onImageVisibilityUpdated(paramImagePerfState, paramInt);
        }
      }
    }
  }
  
  public void notifyStatusUpdated(ImagePerfState paramImagePerfState, int paramInt)
  {
    paramImagePerfState.setImageLoadStatus(paramInt);
    if (mEnabled)
    {
      Object localObject = mImagePerfDataListeners;
      if (localObject != null)
      {
        if (((List)localObject).isEmpty()) {
          return;
        }
        if (paramInt == 3) {
          addViewportData();
        }
        paramImagePerfState = paramImagePerfState.snapshot();
        localObject = mImagePerfDataListeners.iterator();
        while (((Iterator)localObject).hasNext()) {
          ((ImagePerfDataListener)((Iterator)localObject).next()).onImageLoadStatusUpdated(paramImagePerfState, paramInt);
        }
      }
    }
  }
  
  public void removeImagePerfDataListener(ImagePerfDataListener paramImagePerfDataListener)
  {
    List localList = mImagePerfDataListeners;
    if (localList == null) {
      return;
    }
    localList.remove(paramImagePerfDataListener);
  }
  
  public void reset()
  {
    clearImagePerfDataListeners();
    setEnabled(false);
    mImagePerfState.reset();
  }
  
  public void setEnabled(boolean paramBoolean)
  {
    mEnabled = paramBoolean;
    Object localObject;
    if (paramBoolean)
    {
      setupListeners();
      localObject = mImageOriginListener;
      if (localObject != null) {
        mPipelineDraweeController.addImageOriginListener((ImageOriginListener)localObject);
      }
      localObject = mImagePerfControllerListener;
      if (localObject != null) {
        mPipelineDraweeController.addControllerListener((ControllerListener)localObject);
      }
      localObject = mForwardingRequestListener;
      if (localObject != null) {
        mPipelineDraweeController.addRequestListener((RequestListener)localObject);
      }
    }
    else
    {
      localObject = mImageOriginListener;
      if (localObject != null) {
        mPipelineDraweeController.removeImageOriginListener((ImageOriginListener)localObject);
      }
      localObject = mImagePerfControllerListener;
      if (localObject != null) {
        mPipelineDraweeController.removeControllerListener((ControllerListener)localObject);
      }
      localObject = mForwardingRequestListener;
      if (localObject != null) {
        mPipelineDraweeController.removeRequestListener((RequestListener)localObject);
      }
    }
  }
  
  public void updateImageRequestData(AbstractDraweeControllerBuilder paramAbstractDraweeControllerBuilder)
  {
    mImagePerfState.setControllerImageRequests((ImageRequest)paramAbstractDraweeControllerBuilder.getImageRequest(), (ImageRequest)paramAbstractDraweeControllerBuilder.getLowResImageRequest(), (ImageRequest[])paramAbstractDraweeControllerBuilder.getFirstAvailableImageRequests());
  }
}
