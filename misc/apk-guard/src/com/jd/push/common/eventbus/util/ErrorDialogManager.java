package com.jd.push.common.eventbus.util;

import android.annotation.TargetApi;
import android.app.Activity;
import android.os.Build.VERSION;
import android.os.Bundle;
import android.util.Log;
import androidx.fragment.app.FragmentActivity;
import com.jd.push.common.eventbus.EventBus;

public class ErrorDialogManager
{
  public static final String KEY_EVENT_TYPE_ON_CLOSE = "de.greenrobot.eventbus.errordialog.event_type_on_close";
  public static final String KEY_FINISH_AFTER_DIALOG = "de.greenrobot.eventbus.errordialog.finish_after_dialog";
  public static final String KEY_ICON_ID = "de.greenrobot.eventbus.errordialog.icon_id";
  public static final String KEY_MESSAGE = "de.greenrobot.eventbus.errordialog.message";
  public static final String KEY_TITLE = "de.greenrobot.eventbus.errordialog.title";
  protected static final String TAG_ERROR_DIALOG = "de.greenrobot.eventbus.error_dialog";
  protected static final String TAG_ERROR_DIALOG_MANAGER = "de.greenrobot.eventbus.error_dialog_manager";
  public static ErrorDialogFragmentFactory<?> factory;
  
  public ErrorDialogManager() {}
  
  public static void attachTo(Activity paramActivity)
  {
    attachTo(paramActivity, false, null);
  }
  
  public static void attachTo(Activity paramActivity, Object paramObject, boolean paramBoolean, Bundle paramBundle)
  {
    if (factory != null)
    {
      if (isSupportActivity(paramActivity))
      {
        SupportManagerFragment.attachTo(paramActivity, paramObject, paramBoolean, paramBundle);
        return;
      }
      HoneycombManagerFragment.attachTo(paramActivity, paramObject, paramBoolean, paramBundle);
      return;
    }
    throw new RuntimeException("You must set the static factory field to configure error dialogs for your app.");
  }
  
  public static void attachTo(Activity paramActivity, boolean paramBoolean)
  {
    attachTo(paramActivity, paramBoolean, null);
  }
  
  public static void attachTo(Activity paramActivity, boolean paramBoolean, Bundle paramBundle)
  {
    attachTo(paramActivity, paramActivity.getClass(), paramBoolean, paramBundle);
  }
  
  protected static void checkLogException(ThrowableFailureEvent paramThrowableFailureEvent)
  {
    if (factoryconfig.logExceptions)
    {
      String str2 = factoryconfig.tagForLoggingExceptions;
      String str1 = str2;
      if (str2 == null) {
        str1 = EventBus.TAG;
      }
      Log.i(str1, "Error dialog manager received exception", throwable);
    }
  }
  
  private static boolean isInExecutionScope(Object paramObject, ThrowableFailureEvent paramThrowableFailureEvent)
  {
    if (paramThrowableFailureEvent != null)
    {
      paramThrowableFailureEvent = paramThrowableFailureEvent.getExecutionScope();
      if ((paramThrowableFailureEvent != null) && (!paramThrowableFailureEvent.equals(paramObject))) {
        return false;
      }
    }
    return true;
  }
  
  private static boolean isSupportActivity(Activity paramActivity)
  {
    Object localObject1 = paramActivity.getClass();
    Object localObject2;
    do
    {
      localObject2 = ((Class)localObject1).getSuperclass();
      localObject1 = localObject2;
      if (localObject2 == null) {
        break;
      }
      localObject2 = ((Class)localObject2).getName();
      if ("androidx.fragment.app.FragmentActivity".equals(localObject2)) {
        return true;
      }
      if ((((String)localObject2).startsWith("com.actionbarsherlock.app")) && ((((String)localObject2).endsWith(".SherlockActivity")) || (((String)localObject2).endsWith(".SherlockListActivity")) || (((String)localObject2).endsWith(".SherlockPreferenceActivity"))))
      {
        paramActivity = new StringBuilder();
        paramActivity.append("Please use SherlockFragmentActivity. Illegal activity: ");
        paramActivity.append((String)localObject2);
        throw new RuntimeException(paramActivity.toString());
      }
    } while (!"android.app.Activity".equals(localObject2));
    if (Build.VERSION.SDK_INT >= 11) {
      return false;
    }
    throw new RuntimeException("Illegal activity without fragment support. Either use Android 3.0+ or android.support.v4.app.FragmentActivity.");
    localObject1 = new StringBuilder();
    ((StringBuilder)localObject1).append("Illegal activity type: ");
    ((StringBuilder)localObject1).append(paramActivity.getClass());
    throw new RuntimeException(((StringBuilder)localObject1).toString());
  }
  
  @TargetApi(11)
  public static class HoneycombManagerFragment
    extends android.app.Fragment
  {
    protected Bundle argumentsForErrorDialog;
    private EventBus eventBus;
    private Object executionScope;
    protected boolean finishAfterDialog;
    
    public HoneycombManagerFragment() {}
    
    public static void attachTo(Activity paramActivity, Object paramObject, boolean paramBoolean, Bundle paramBundle)
    {
      android.app.FragmentManager localFragmentManager = paramActivity.getFragmentManager();
      if ((localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog_manager") instanceof HoneycombManagerFragment)) {
        paramActivity = (HoneycombManagerFragment)localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog_manager");
      } else {
        paramActivity = null;
      }
      Object localObject = paramActivity;
      if (paramActivity == null)
      {
        localObject = new HoneycombManagerFragment();
        localFragmentManager.beginTransaction().add((android.app.Fragment)localObject, "de.greenrobot.eventbus.error_dialog_manager").commit();
        localFragmentManager.executePendingTransactions();
      }
      finishAfterDialog = paramBoolean;
      argumentsForErrorDialog = paramBundle;
      executionScope = paramObject;
    }
    
    public void onEventMainThread(ThrowableFailureEvent paramThrowableFailureEvent)
    {
      if (!ErrorDialogManager.isInExecutionScope(executionScope, paramThrowableFailureEvent)) {
        return;
      }
      ErrorDialogManager.checkLogException(paramThrowableFailureEvent);
      android.app.FragmentManager localFragmentManager = getFragmentManager();
      localFragmentManager.executePendingTransactions();
      boolean bool = localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog") instanceof android.app.DialogFragment;
      Object localObject2 = null;
      if (bool) {
        localObject1 = (android.app.DialogFragment)localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog");
      } else {
        localObject1 = null;
      }
      if (localObject1 != null) {
        ((android.app.DialogFragment)localObject1).dismiss();
      }
      Object localObject1 = localObject2;
      if ((ErrorDialogManager.factory.prepareErrorFragment(paramThrowableFailureEvent, finishAfterDialog, argumentsForErrorDialog) instanceof android.app.DialogFragment)) {
        localObject1 = (android.app.DialogFragment)ErrorDialogManager.factory.prepareErrorFragment(paramThrowableFailureEvent, finishAfterDialog, argumentsForErrorDialog);
      }
      if (localObject1 != null) {
        ((android.app.DialogFragment)localObject1).show(localFragmentManager, "de.greenrobot.eventbus.error_dialog");
      }
    }
    
    public void onPause()
    {
      eventBus.unregister(this);
      super.onPause();
    }
    
    public void onResume()
    {
      super.onResume();
      eventBus = factoryconfig.getEventBus();
      eventBus.register(this);
    }
  }
  
  public static class SupportManagerFragment
    extends androidx.fragment.app.Fragment
  {
    protected Bundle argumentsForErrorDialog;
    private EventBus eventBus;
    private Object executionScope;
    protected boolean finishAfterDialog;
    private boolean skipRegisterOnNextResume;
    
    public SupportManagerFragment() {}
    
    public static void attachTo(Activity paramActivity, Object paramObject, boolean paramBoolean, Bundle paramBundle)
    {
      boolean bool = paramActivity instanceof FragmentActivity;
      Object localObject = null;
      androidx.fragment.app.FragmentManager localFragmentManager;
      if (bool) {
        localFragmentManager = ((FragmentActivity)paramActivity).getSupportFragmentManager();
      } else {
        localFragmentManager = null;
      }
      if (localFragmentManager == null) {
        return;
      }
      paramActivity = (Activity)localObject;
      if ((localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog_manager") instanceof SupportManagerFragment)) {
        paramActivity = (SupportManagerFragment)localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog_manager");
      }
      localObject = paramActivity;
      if (paramActivity == null)
      {
        localObject = new SupportManagerFragment();
        localFragmentManager.beginTransaction().add((androidx.fragment.app.Fragment)localObject, "de.greenrobot.eventbus.error_dialog_manager").commit();
        localFragmentManager.executePendingTransactions();
      }
      finishAfterDialog = paramBoolean;
      argumentsForErrorDialog = paramBundle;
      executionScope = paramObject;
    }
    
    public void onCreate(Bundle paramBundle)
    {
      super.onCreate(paramBundle);
      eventBus = factoryconfig.getEventBus();
      eventBus.register(this);
      skipRegisterOnNextResume = true;
    }
    
    public void onEventMainThread(ThrowableFailureEvent paramThrowableFailureEvent)
    {
      if (!ErrorDialogManager.isInExecutionScope(executionScope, paramThrowableFailureEvent)) {
        return;
      }
      ErrorDialogManager.checkLogException(paramThrowableFailureEvent);
      androidx.fragment.app.FragmentManager localFragmentManager = getFragmentManager();
      localFragmentManager.executePendingTransactions();
      boolean bool = localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog") instanceof androidx.fragment.app.DialogFragment;
      Object localObject2 = null;
      if (bool) {
        localObject1 = (androidx.fragment.app.DialogFragment)localFragmentManager.findFragmentByTag("de.greenrobot.eventbus.error_dialog");
      } else {
        localObject1 = null;
      }
      if (localObject1 != null) {
        ((androidx.fragment.app.DialogFragment)localObject1).dismiss();
      }
      Object localObject1 = localObject2;
      if ((ErrorDialogManager.factory.prepareErrorFragment(paramThrowableFailureEvent, finishAfterDialog, argumentsForErrorDialog) instanceof androidx.fragment.app.DialogFragment)) {
        localObject1 = (androidx.fragment.app.DialogFragment)ErrorDialogManager.factory.prepareErrorFragment(paramThrowableFailureEvent, finishAfterDialog, argumentsForErrorDialog);
      }
      if (localObject1 != null) {
        ((androidx.fragment.app.DialogFragment)localObject1).show(localFragmentManager, "de.greenrobot.eventbus.error_dialog");
      }
    }
    
    public void onPause()
    {
      eventBus.unregister(this);
      super.onPause();
    }
    
    public void onResume()
    {
      super.onResume();
      if (skipRegisterOnNextResume)
      {
        skipRegisterOnNextResume = false;
        return;
      }
      eventBus = factoryconfig.getEventBus();
      eventBus.register(this);
    }
  }
}
