package com.jd.framework.a.a;

import android.text.TextUtils;
import com.huawei.hms.framework.common.ContainerUtils;
import com.jd.framework.a.b.b;
import com.jd.framework.network.JDNetworkResponse;
import com.jd.framework.network.JDResponse;
import com.jd.framework.network.error.JDError;
import com.jd.framework.network.request.JDRequest;
import com.jingdong.jdsdk.network.JDHttpTookit;
import com.jingdong.sdk.oklog.OKLog;
import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;
import java.util.zip.GZIPInputStream;
import okhttp3.Headers;
import okhttp3.Request;
import okhttp3.Response;
import okhttp3.ResponseBody;

/* compiled from: TbsSdkJava */
/* loaded from: classes.dex */
public class a {
    public static final String a = "a";
    public static String b = "utf-8";
    private static int d = 4096;
    protected final com.jd.framework.a.b.a c = new com.jd.framework.a.b.a(d);

    public Request a(JDRequest<?> jDRequest) {
        Request.Builder url = new Request.Builder().url(jDRequest.getUrl());
        if (OKLog.D) {
            OKLog.d(a, "request Header Fields : ");
        }
        Map<String, String> header = jDRequest.getHeader();
        for (String str : header.keySet()) {
            url.addHeader(str, header.get(str));
            if (OKLog.D) {
                String str2 = a;
                OKLog.d(str2, str + " : " + header.get(str));
            }
        }
        try {
            String cookie = JDHttpTookit.getEngine().getLoginUserControllerImpl().getCookie();
            if (!TextUtils.isEmpty(cookie)) {
                url.addHeader("Cookie", cookie);
                url.addHeader("jdc-backup", cookie);
            }
        } catch (Throwable unused) {
        }
        if (!TextUtils.isEmpty(jDRequest.getTag())) {
            url.tag(jDRequest.getTag());
        }
        try {
            a(url, jDRequest);
        } catch (IOException e) {
            e.printStackTrace();
        }
        return url.build();
    }

    public JDResponse<?> a(JDRequest<?> jDRequest, Response response) {
        JDResponse<?> jDResponse = new JDResponse<>();
        if (response != null) {
            if (response.body() != null) {
                try {
                    jDResponse.setData(new String(a(response), a(response, b)));
                } catch (IOException unused) {
                }
            }
            jDResponse.setHeaders(a(response.headers()));
        }
        return jDResponse;
    }

    public JDError a(JDRequest<?> jDRequest, Exception exc, Response response) {
        JDResponse<?> jDResponse;
        JDError jDError = null;
        try {
            jDResponse = a(jDRequest, response);
        } catch (Exception e) {
            e.printStackTrace();
            jDResponse = null;
        }
        if (exc != null) {
            jDError = new JDError(exc);
        }
        if (jDResponse != null) {
            jDError.networkResponse = new JDNetworkResponse(jDResponse.getStatusCode(), jDResponse.getHeaders(), jDResponse.getData() != null ? jDResponse.getData().toString() : "");
        }
        return jDError;
    }

    private HashMap<String, String> a(Headers headers) {
        if (headers == null && headers.size() <= 0) {
            return null;
        }
        HashMap<String, String> hashMap = new HashMap<>();
        int size = headers.size();
        for (int i = 0; i < size; i++) {
            if (!TextUtils.isEmpty(headers.name(i)) && !TextUtils.isEmpty(headers.value(i))) {
                hashMap.put(headers.name(i), headers.value(i));
            }
        }
        return hashMap;
    }

    private void a(Request.Builder builder, JDRequest jDRequest) throws IOException {
        int method = jDRequest.getMethod();
        if (method == 0) {
            builder.get();
        } else if (method == 3) {
            builder.delete();
        } else {
            throw new IllegalStateException("Unknown method type.");
        }
    }

    public static String a(Response response, String str) {
        String header = response.header("Content-Type");
        if (header == null) {
            header = response.header("content-type");
        }
        if (header != null) {
            String[] split = header.split(";");
            for (int i = 1; i < split.length; i++) {
                String[] split2 = split[i].trim().split(ContainerUtils.KEY_VALUE_DELIMITER);
                if (split2.length == 2 && split2[0].equals("charset")) {
                    return split2[1];
                }
            }
        }
        return str;
    }

    private byte[] a(Response response) throws IOException {
        InputStream inputStream;
        String header = response.header("Content-Encoding");
        ResponseBody body = response.body();
        if ("gzip".equals(header)) {
            inputStream = new GZIPInputStream(body.byteStream());
        } else {
            inputStream = body.byteStream();
        }
        b bVar = new b(this.c, (int) body.contentLength());
        byte[] bArr = null;
        try {
            bArr = this.c.a(1024);
            while (true) {
                int read = inputStream.read(bArr);
                if (read == -1) {
                    break;
                }
                bVar.write(bArr, 0, read);
            }
            byte[] byteArray = bVar.toByteArray();
            if (inputStream != null) {
                try {
                    inputStream.close();
                } catch (IOException unused) {
                    OKLog.v("Error occured when calling consumingContent", new Object[0]);
                }
            }
            this.c.a(bArr);
            bVar.close();
            return byteArray;
        } catch (Throwable th) {
            if (inputStream != null) {
                try {
                    inputStream.close();
                } catch (IOException unused2) {
                    OKLog.v("Error occured when calling consumingContent", new Object[0]);
                }
            }
            this.c.a(bArr);
            bVar.close();
            throw th;
        }
    }
}
