package com.jd.sentry.performance.block.a;

import android.os.Build;
import android.os.Process;
import android.text.TextUtils;
import com.jd.sentry.Sentry;
import com.jd.sentry.performance.block.c.c;
import com.jd.sentry.util.Log;
import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

/* loaded from: classes.dex */
public class b extends a {
    private static int d;
    private final LinkedHashMap<Long, c> e = new LinkedHashMap<>();
    private int f = 0;
    private long g = 0;
    private long h = 0;
    private long i = 0;
    private long j = 0;
    private long k = 0;
    private long l = 0;
    private final int c = (int) (((float) c()) * 1.2f);

    public b(long j) {
        super(j);
    }

    private int a(String str) {
        if (!str.contains("CPU")) {
            return -1;
        }
        String[] split = str.split("\\s+");
        for (int i = 0; i < split.length; i++) {
            if (split[i].contains("CPU")) {
                return i;
            }
        }
        return -1;
    }

    private void a(long j, c cVar) {
        c remove;
        synchronized (this.e) {
            this.e.put(Long.valueOf(j), cVar);
            if (this.e.size() > d) {
                Iterator<Map.Entry<Long, c>> it = this.e.entrySet().iterator();
                if (it.hasNext() && (remove = this.e.remove(it.next().getKey())) != null) {
                    remove.b();
                }
            }
        }
    }

    private void a(String str, String str2) {
        long j;
        long j2;
        long j3;
        long j4;
        long j5;
        String[] split = str.split(" ");
        if (split.length >= 9) {
            long parseLong = Long.parseLong(split[2]);
            long parseLong2 = Long.parseLong(split[3]);
            long parseLong3 = Long.parseLong(split[4]);
            long parseLong4 = Long.parseLong(split[5]);
            long parseLong5 = Long.parseLong(split[6]);
            long parseLong6 = parseLong2 + parseLong + parseLong3 + parseLong4 + parseLong5 + Long.parseLong(split[7]) + Long.parseLong(split[8]);
            String[] split2 = str2.split(" ");
            if (split2.length >= 17) {
                long parseLong7 = Long.parseLong(split2[13]) + Long.parseLong(split2[14]) + Long.parseLong(split2[15]) + Long.parseLong(split2[16]);
                if (this.k != 0) {
                    c a = c.a();
                    long j6 = parseLong4 - this.i;
                    j4 = parseLong4;
                    long j7 = parseLong6 - this.k;
                    double d2 = (double) (j7 - j6);
                    double d3 = (double) j7;
                    Double.isNaN(d2);
                    Double.isNaN(d3);
                    j3 = parseLong6;
                    double d4 = (double) (parseLong7 - this.l);
                    Double.isNaN(d4);
                    Double.isNaN(d3);
                    j2 = parseLong7;
                    double d5 = (double) (parseLong - this.g);
                    Double.isNaN(d5);
                    Double.isNaN(d3);
                    double d6 = d5 / d3;
                    double d7 = (double) (parseLong3 - this.h);
                    Double.isNaN(d7);
                    Double.isNaN(d3);
                    j = parseLong3;
                    double d8 = (double) (parseLong5 - this.j);
                    Double.isNaN(d8);
                    Double.isNaN(d3);
                    long currentTimeMillis = System.currentTimeMillis();
                    a.c = currentTimeMillis;
                    NumberFormat percentInstance = NumberFormat.getPercentInstance();
                    percentInstance.setMaximumFractionDigits(2);
                    a.d = percentInstance.format(d2 / d3);
                    a.e = percentInstance.format(d4 / d3);
                    a.f = percentInstance.format(d6);
                    a.g = percentInstance.format(d7 / d3);
                    a.h = percentInstance.format(d8 / d3);
                    a(currentTimeMillis, a);
                    j5 = parseLong;
                } else {
                    j3 = parseLong6;
                    j = parseLong3;
                    j4 = parseLong4;
                    j2 = parseLong7;
                    j5 = parseLong;
                }
                this.g = j5;
                this.h = j;
                this.i = j4;
                this.j = parseLong5;
                this.k = j3;
                this.l = j2;
            }
        }
    }

    private void e() {
        BufferedReader bufferedReader;
        Throwable th;
        String readLine;
        BufferedReader bufferedReader2;
        try {
            BufferedReader bufferedReader3 = null;
            try {
                bufferedReader = new BufferedReader(new InputStreamReader(new FileInputStream("/proc/stat")), 1000);
                try {
                    readLine = bufferedReader.readLine();
                    if (readLine == null) {
                        readLine = "";
                    }
                    if (this.f == 0) {
                        this.f = Process.myPid();
                    }
                    bufferedReader2 = new BufferedReader(new InputStreamReader(new FileInputStream("/proc/" + this.f + "/stat")), 1000);
                } catch (Throwable unused) {
                }
            } catch (Throwable unused2) {
                bufferedReader = null;
            }
            try {
                String readLine2 = bufferedReader2.readLine();
                if (readLine2 == null) {
                    readLine2 = "";
                }
                a(readLine, readLine2);
                bufferedReader.close();
                bufferedReader2.close();
            } catch (Throwable th2) {
                th = th2;
                bufferedReader3 = bufferedReader2;
                if (bufferedReader != null) {
                    try {
                        bufferedReader.close();
                    } catch (IOException unused3) {
                        throw th;
                    }
                }
                if (bufferedReader3 != null) {
                    bufferedReader3.close();
                }
                throw th;
            }
        } catch (IOException unused4) {
        }
    }

    private void f() {
        this.g = 0;
        this.h = 0;
        this.i = 0;
        this.j = 0;
        this.k = 0;
        this.l = 0;
    }

    private void g() {
        c a = c.a();
        Process process = null;
        try {
            process = Runtime.getRuntime().exec("top -n 1");
            BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            int i = -1;
            while (true) {
                String readLine = bufferedReader.readLine();
                if (readLine == null) {
                    break;
                }
                String trim = readLine.trim();
                if (!TextUtils.isEmpty(trim)) {
                    int a2 = a(trim);
                    if (a2 != -1) {
                        i = a2;
                    } else if (trim.startsWith(String.valueOf(Process.myPid())) && i != -1) {
                        String[] split = trim.split("\\s+");
                        if (split.length > i) {
                            String str = split[i];
                            if (str.endsWith("%")) {
                                str = str.substring(0, str.lastIndexOf("%"));
                            }
                            long currentTimeMillis = System.currentTimeMillis();
                            float parseFloat = Float.parseFloat(str) / ((float) Runtime.getRuntime().availableProcessors());
                            NumberFormat percentInstance = NumberFormat.getPercentInstance();
                            percentInstance.setMaximumFractionDigits(2);
                            a.c = currentTimeMillis;
                            a.e = percentInstance.format((double) parseFloat);
                            a.d = percentInstance.format(0L);
                            a.f = percentInstance.format(0L);
                            a.g = percentInstance.format(0L);
                            a.h = percentInstance.format(0L);
                            a(currentTimeMillis, a);
                        }
                    }
                }
            }
            if (process == null) {
                return;
            }
        } catch (Throwable th) {
            if (process != null) {
                process.destroy();
            }
            throw th;
        }
        process.destroy();
    }

    public List<com.jd.sentry.performance.block.c.b> a(String str, long j, long j2) {
        ArrayList arrayList = new ArrayList();
        synchronized (this.e) {
            for (Long l : this.e.keySet()) {
                if (j < l.longValue() && l.longValue() < j2) {
                    com.jd.sentry.performance.block.c.b bVar = new com.jd.sentry.performance.block.c.b();
                    bVar.a = str;
                    bVar.e = this.e.get(l).c;
                    bVar.j = this.e.get(l).h;
                    bVar.f = this.e.get(l).d;
                    bVar.g = this.e.get(l).e;
                    bVar.i = this.e.get(l).g;
                    bVar.h = this.e.get(l).f;
                    arrayList.add(bVar);
                }
            }
        }
        return arrayList;
    }

    @Override // com.jd.sentry.performance.block.a.a
    public void a() {
        super.a();
        f();
    }

    @Override // com.jd.sentry.performance.block.a.a
    long c() {
        return (long) Sentry.getSentryConfig().getBlockContext().b();
    }

    @Override // com.jd.sentry.performance.block.a.a
    protected void d() {
        if (Log.LOGSWITCH && Log.LOGSWICTH_BLOCK) {
            Log.d("block", "CpuSamper doSample");
        }
        if (Build.VERSION.SDK_INT >= 26) {
            g();
        } else {
            e();
        }
    }
}
